<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emre Bebe Toptan Müşteri Poşet Takibi (Bulut Tabanlı)</title>

    <!-- PWA için Gerekli Etiketler -->
    <meta name="theme-color" content="#1e293b"/>
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Genel Stil ve Geçişler */
        :root {
            --bg-primary: #1e293b; /* bg-slate-800 */
            --bg-secondary: #0f172a; /* bg-slate-900 */
            --bg-tertiary: #334155; /* bg-slate-700 */
            --text-primary: #cbd5e1; /* text-slate-300 */
            --text-secondary: #94a3b8; /* text-slate-400 */
            --border-color: #475569; /* border-slate-600 */
            --accent-color: #a78bfa; /* purple-400 */
            --accent-color-dark: #8b5cf6; /* purple-600 */
            --font-size-base: 16px;
        }

        .theme-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --accent-color: #8b5cf6;
            --accent-color-dark: #7c3aed;
        }

        .theme-night-blue {
            --bg-primary: #1c2a4a;
            --bg-secondary: #0d1a33;
            --bg-tertiary: #2a3a5a;
            --text-primary: #e0e7ff;
            --text-secondary: #a0b3d4;
            --border-color: #3a4a6a;
            --accent-color: #7aa2f7;
            --accent-color-dark: #5a82e7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            transition: background-color 0.3s, color 0.3s;
        }

        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-dynamic { border-color: var(--border-color); }
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color-dark); }
        .accent-bg-hover:hover { background-color: var(--accent-color); }
        .ring-accent:focus { --tw-ring-color: var(--accent-color); }
        
        .tab-active { border-color: var(--accent-color) !important; color: var(--text-primary) !important; }
        .sort-active { background-color: var(--bg-tertiary); color: var(--text-primary); }

        .panel { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; will-change: opacity, transform; }
        .panel.hidden { opacity: 0; transform: translateY(10px); pointer-events: none; position: absolute; width: 100%; }
        
        #modal-container.hidden { pointer-events: none; opacity: 0; }
        #modal-content-wrapper.hidden { transform: scale(0.95); opacity: 0; }
        .pagination-btn { min-width: 2.5rem; }
        .pagination-btn.active { background-color: var(--accent-color-dark); color: white; font-weight: bold; }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            color: var(--text-primary);
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body class="bg-secondary text-primary">

    <div id="loading-overlay">
        <div id="loading-spinner">
            <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <p id="loading-text">Veritabanına bağlanılıyor...</p>
        <div id="retry-container" class="hidden mt-4">
            <button id="retry-button" class="accent-bg text-white font-semibold py-2 px-4 rounded-lg accent-bg-hover transition">Yeniden Dene</button>
        </div>
    </div>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8 min-h-screen opacity-0 transition-opacity duration-500">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-primary">Emre Bebe Toptan Müşteri Poşet Takibi</h1>
            <p class="mt-2 text-secondary">Tüm müşteri emanetlerinizi tek yerden yönetin.</p>
        </header>

        <!-- Sekme Navigasyonu -->
        <div class="mb-6 border-b border-dynamic">
            <nav class="-mb-px flex space-x-2 sm:space-x-6 overflow-x-auto" aria-label="Tabs">
                <button id="tab-list" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Liste</button>
                <button id="tab-archive" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Teslim Edilenler</button>
                <button id="tab-reports" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Raporlar</button>
                <button id="tab-notes" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Notlarım</button>
                <button id="tab-settings" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Ayarlar</button>
            </nav>
        </div>

        <!-- Sekme İçerikleri -->
        <main id="main-content" class="relative">
            <!-- Liste Sekmesi -->
            <div id="panel-list" class="panel space-y-8">
                 <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">Yeni Poşet Ekle</h2>
                    <form id="add-item-form" class="grid grid-cols-1 sm:grid-cols-5 gap-4">
                        <div class="relative sm:col-span-3">
                            <input type="text" id="customer-name" placeholder="Müşteri Adı Soyadı" class="w-full p-3 bg-tertiary border border-dynamic text-primary rounded-lg focus:ring-2 ring-accent transition" required autocomplete="off">
                            <div id="suggestions-box" class="hidden absolute top-full left-0 right-0 z-20 bg-tertiary border border-t-0 border-dynamic rounded-b-lg shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>
                        <input type="number" id="bag-count" placeholder="Poşet Sayısı" value="1" min="1" class="sm:col-span-1 w-full p-3 bg-tertiary border border-dynamic text-primary rounded-lg focus:ring-2 ring-accent transition" required>
                        <button type="submit" class="sm:col-span-1 w-full accent-bg text-white font-semibold p-3 rounded-lg accent-bg-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-secondary ring-accent transition-all">Ekle</button>
                    </form>
                </div>
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold text-primary flex items-center gap-3">Bekleyen Poşetler <span id="total-bags-counter" class="text-base font-medium bg-purple-500/20 text-purple-300 py-1 px-3 rounded-full" title="Toplam Poşet Sayısı"></span></h2>
                        <div class="flex items-center gap-2">
                             <input type="search" id="search-items-input" placeholder="Listede ara..." class="p-2 bg-tertiary border border-dynamic rounded-lg focus:ring-2 ring-accent transition w-full sm:w-auto">
                             <div class="flex border border-dynamic rounded-lg">
                                <button id="sort-alpha" class="p-2 text-secondary hover:bg-tertiary rounded-l-md" title="Alfabetik Sırala"></button>
                                <button id="sort-bags" class="p-2 text-secondary hover:bg-tertiary border-l border-dynamic" title="Poşet Sayısına Göre Sırala"></button>
                                <button id="sort-date" class="p-2 text-secondary hover:bg-tertiary border-l border-dynamic rounded-r-md" title="Tarihe Göre Sırala"></button>
                            </div>
                        </div>
                    </div>
                    <div id="item-list" class="space-y-2"></div>
                    <p id="empty-item-list-message" class="hidden text-center text-secondary bg-primary border border-dynamic p-6 rounded-xl shadow-lg">Henüz bekleyen poşet bulunmuyor.</p>
                </div>
            </div>

            <!-- Arşiv Sekmesi -->
            <div id="panel-archive" class="panel hidden space-y-4">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-primary">Teslim Edilenler Arşivi</h2>
                    <input type="search" id="search-archive-input" placeholder="Arşivde ara..." class="p-2 bg-tertiary border border-dynamic rounded-lg focus:ring-2 ring-accent transition w-full sm:w-auto">
                </div>
                <div id="archive-list" class="space-y-2"></div>
                <div id="archive-pagination" class="flex justify-center items-center mt-4 space-x-2"></div>
                <p id="empty-archive-list-message" class="hidden text-center text-secondary bg-primary border border-dynamic p-6 rounded-xl shadow-lg">Arşivde hiç kayıt bulunmuyor.</p>
            </div>
            
            <!-- Raporlar Sekmesi -->
            <div id="panel-reports" class="panel hidden space-y-8">
                 <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">Dönemsel Raporlar</h2>
                    <div class="flex gap-2 mb-4">
                        <button data-range="7" class="report-range-btn flex-1 bg-tertiary p-2 rounded-lg hover:bg-purple-500/30">Son 7 Gün</button>
                        <button data-range="30" class="report-range-btn flex-1 bg-tertiary p-2 rounded-lg hover:bg-purple-500/30">Son 30 Gün</button>
                        <button data-range="all" class="report-range-btn flex-1 bg-tertiary p-2 rounded-lg hover:bg-purple-500/30">Tüm Zamanlar</button>
                    </div>
                    <div id="periodic-report-content" class="text-center p-4 bg-secondary rounded-lg border border-dynamic">
                        Raporu görmek için bir zaman aralığı seçin.
                    </div>
                </div>
                 <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">En Uzun Süredir Bekleyen 10 Poşet</h2>
                    <div id="overdue-report-list" class="space-y-2"></div>
                     <p id="empty-overdue-report-message" class="hidden text-center text-secondary p-4">Tüm poşetler teslim edilmiş veya yeni.</p>
                </div>
            </div>

            <!-- Notlar Sekmesi -->
            <div id="panel-notes" class="panel hidden space-y-4">
                <h2 class="text-2xl font-semibold text-primary">Tüm Notlar</h2>
                <div id="notes-list" class="space-y-2"></div>
                <p id="empty-notes-message" class="hidden text-center text-secondary bg-primary border border-dynamic p-6 rounded-xl shadow-lg">Henüz not eklenmiş bir kayıt bulunmuyor.</p>
            </div>

            <!-- Ayarlar Sekmesi -->
            <div id="panel-settings" class="panel hidden space-y-8">
                <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic space-y-6">
                    <h2 class="text-2xl font-semibold text-primary">Görünüm Ayarları</h2>
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Tema</h3>
                        <div class="flex gap-2">
                            <button data-theme="dark" class="theme-btn flex-1 p-2 rounded-lg border-2 border-slate-700 bg-slate-800 text-slate-300">Varsayılan</button>
                            <button data-theme="light" class="theme-btn flex-1 p-2 rounded-lg border-2 border-gray-300 bg-white text-black">Açık</button>
                            <button data-theme="night-blue" class="theme-btn flex-1 p-2 rounded-lg border-2 border-indigo-900 bg-blue-950 text-blue-200">Gece Mavisi</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Yazı Tipi Boyutu (<span id="font-size-preview">16px</span>)</h3>
                        <input type="range" id="font-size-slider" min="12" max="20" step="1" value="16" class="w-full h-2 bg-tertiary rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic space-y-6">
                    <h2 class="text-2xl font-semibold text-primary">Müşteri Yönetimi</h2>
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Müşteri Listesi Yönetimi</h3>
                        <button id="manage-customers-btn" class="w-full bg-tertiary text-primary font-semibold p-3 rounded-lg hover:bg-slate-600 transition-all">
                            Müşteri Listesini Görüntüle ve Yönet
                        </button>
                    </div>
                </div>
                
                <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic space-y-6">
                    <h2 class="text-2xl font-semibold text-primary">Veri Yönetimi</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="export-json-btn" class="w-full bg-sky-600 text-white font-semibold p-3 rounded-lg hover:bg-sky-700 transition">Yedekle (JSON)</button>
                        <button id="import-json-btn" class="w-full bg-teal-600 text-white font-semibold p-3 rounded-lg hover:bg-teal-700 transition">Geri Yükle (JSON)</button>
                        <button id="export-pdf-btn" class="w-full bg-rose-600 text-white font-semibold p-3 rounded-lg hover:bg-rose-700 transition">Listeyi PDF Aktar</button>
                        <button id="export-csv-btn" class="w-full bg-emerald-600 text-white font-semibold p-3 rounded-lg hover:bg-emerald-700 transition">Listeyi CSV Aktar</button>
                         <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                    <div>
                         <h3 class="text-lg font-medium text-red-400 mb-2">Tehlikeli Alan</h3>
                         <div class="p-4 border border-red-500/30 bg-red-500/10 rounded-lg space-y-3">
                            <p class="text-sm text-red-300">Bu işlemler geri alınamaz. Lütfen dikkatli olun.</p>
                             <button id="reset-items-btn" class="w-full bg-red-700 text-white font-semibold p-2 rounded-lg hover:bg-red-800 transition">Sadece Poşet Listesini Sıfırla</button>
                            <button id="reset-all-btn" class="w-full bg-red-600 text-white font-bold p-3 rounded-lg hover:bg-red-700 transition">TÜM VERİLERİ SIFIRLA</button>
                         </div>
                    </div>
                </div>
                <div class="text-center mt-4 mb-4">
                    <p class="text-xs text-secondary">Program yapımcısı Muhammed Ali KOÇ</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="modal-content-wrapper" class="bg-primary border border-dynamic rounded-lg shadow-xl p-6 w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0">
             <div id="modal-content"></div>
        </div>
    </div>

    <script type="module">
        // Firebase Modüllerini İçe Aktar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, 
            onSnapshot, query, where, serverTimestamp, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE YAPILANDIRMASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsIDN74rIPhYtdaTIkeGcrczxQEjr7-sw",
            authDomain: "emre-bebe-takip.firebaseapp.com",
            projectId: "emre-bebe-takip",
            storageBucket: "emre-bebe-takip.firebasestorage.app",
            messagingSenderId: "174642780473",
            appId: "1:174642780473:web:89c50d5f80612c16e3f0e8"
        };
        
        // Gerekli kütüphaneleri yükle
        const { jsPDF } = window.jspdf;

        // --- UYGULAMA MANTIĞI ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTLERİ ---
            const allElements = {
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingSpinner: document.getElementById('loading-spinner'),
                loadingText: document.getElementById('loading-text'),
                retryContainer: document.getElementById('retry-container'),
                retryButton: document.getElementById('retry-button'),
                appContainer: document.getElementById('app-container'),
                mainContent: document.getElementById('main-content'),
                itemList: document.getElementById('item-list'),
                emptyItemListMessage: document.getElementById('empty-item-list-message'),
                searchItemsInput: document.getElementById('search-items-input'),
                totalBagsCounter: document.getElementById('total-bags-counter'),
                sortAlphaBtn: document.getElementById('sort-alpha'),
                sortBagsBtn: document.getElementById('sort-bags'),
                sortDateBtn: document.getElementById('sort-date'),
                addItemForm: document.getElementById('add-item-form'),
                customerNameInput: document.getElementById('customer-name'),
                bagCountInput: document.getElementById('bag-count'),
                suggestionsBox: document.getElementById('suggestions-box'),
                archiveList: document.getElementById('archive-list'),
                emptyArchiveListMessage: document.getElementById('empty-archive-list-message'),
                searchArchiveInput: document.getElementById('search-archive-input'),
                archivePagination: document.getElementById('archive-pagination'),
                notesList: document.getElementById('notes-list'),
                emptyNotesMessage: document.getElementById('empty-notes-message'),
                manageCustomersBtn: document.getElementById('manage-customers-btn'),
                exportJsonBtn: document.getElementById('export-json-btn'),
                importJsonBtn: document.getElementById('import-json-btn'),
                importFileInput: document.getElementById('import-file-input'),
                resetItemsBtn: document.getElementById('reset-items-btn'),
                resetAllBtn: document.getElementById('reset-all-btn'),
                modalContainer: document.getElementById('modal-container'),
                modalContentWrapper: document.getElementById('modal-content-wrapper'),
                modalContent: document.getElementById('modal-content'),
            };

            // --- STATE (DURUM) YÖNETİMİ ---
            let app, auth, db;
            let allItems = [];
            let allCustomers = [];
            let settings = {};
            let sortState = { type: 'alpha', direction: 'asc' };
            let archiveCurrentPage = 1;
            const itemsPerPage = 10;
            let itemsUnsubscribe = null;
            let customersUnsubscribe = null;
            let connectionTimeout = null;

            // --- İKONLAR ---
            const icons = {
                alpha_asc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.082 12.629 9.664 14H8.598l1.789-5.332h1.234L13.402 14h-1.12l-.419-1.371h-1.781zm1.57-1.055h-1.296l.648-2.042.648 2.042z"/><path d="M12.96 7.022c.16-.21.283-.417.371-.622h.043c.09.205.214.412.375.622L15.04 8.5h-1.2l-.71-1.258h-.043l-.71 1.258h-1.21l1.83-3.05zM4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L4.5 12.293V2.5z"/></svg>',
                alpha_desc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.082 3.629 9.664 2H8.598l1.789 5.332h1.234L13.402 2h-1.12l-.419 1.371h-1.781zm1.57 1.055h-1.296l.648 2.042.648 2.042z"/><path d="M12.96 10.022c.16.21.283-.417.371.622h.043c.09-.205.214-.412.375-.622L15.04 8.5h-1.2l-.71 1.258h-.043l-.71-1.258h-1.21l1.83 3.05zM4.5 13.5a.5.5 0 0 1-1 0V3.707L2.354 4.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L4.5 3.707V13.5z"/></svg>',
                bags_desc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11.5 2.707V14.5a.5.5 0 0 0 .5.5z"/><path fill-rule="evenodd" d="M2.5 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/></svg>',
                bags_asc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L11.5 13.293V1.5a.5.5 0 0 1 .5-.5z"/><path fill-rule="evenodd" d="M2.5 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/></svg>',
                date_desc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg>',
                date_asc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 8.854a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0l-1.5 1.5a.5.5 0 0 0 .708.708L7.5 6.707l2.646 2.647a.5.5 0 0 0 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg>',
                edit: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.293z"/></svg>',
                delete: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg>',
                save: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg>',
                cancel: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/></svg>',
            };

            // --- YARDIMCI FONKSİYONLAR ---
            const getSettingsFromStorage = () => JSON.parse(localStorage.getItem('emanet-settings-v2')) || { theme: 'dark', fontSize: 16 };
            const saveSettingsToStorage = (settings) => localStorage.setItem('emanet-settings-v2', JSON.stringify(settings));
            const formatDate = (iso) => {
                if(!iso) return '';
                const date = iso.seconds ? new Date(iso.seconds * 1000) : new Date(iso);
                return date.toLocaleString('tr-TR', { dateStyle: 'short', timeStyle: 'short'});
            };
            const formatRelativeTime = (iso) => {
                if (!iso) return '';
                const date = iso.seconds ? new Date(iso.seconds * 1000) : new Date(iso);
                const now = new Date();
                const diffDays = Math.floor((now.setHours(0,0,0,0) - date.setHours(0,0,0,0)) / (1000 * 60 * 60 * 24));
                if (diffDays < 0) return '';
                if (diffDays === 0) return 'bugün';
                if (diffDays === 1) return 'dün';
                return `${diffDays} gün önce`;
            };

            function showApp() {
                clearTimeout(connectionTimeout);
                allElements.loadingOverlay.style.opacity = '0';
                allElements.appContainer.style.opacity = '1';
                setTimeout(() => { allElements.loadingOverlay.style.display = 'none'; }, 300);
            }

            function showConnectionError(message) {
                allElements.loadingSpinner.style.display = 'none';
                allElements.retryContainer.classList.remove('hidden');
                allElements.loadingText.innerHTML = `<span class="text-red-400 font-semibold">${message}</span>`;
            }

            // --- AYARLAR ---
            function applySettings() {
                document.body.className = `theme-${settings.theme} text-primary`;
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('ring-2', btn.dataset.theme === settings.theme);
                    btn.classList.toggle('ring-accent', btn.dataset.theme === settings.theme);
                });

                document.body.style.fontSize = `${settings.fontSize}px`;
                const fontSizeSlider = document.getElementById('font-size-slider');
                const fontSizePreview = document.getElementById('font-size-preview');
                if(fontSizeSlider) fontSizeSlider.value = settings.fontSize;
                if(fontSizePreview) fontSizePreview.textContent = `${settings.fontSize}px`;
            }

            // --- RENDER FONKSİYONLARI ---
            function renderAll() {
                const activeItems = allItems.filter(item => item.status !== 'delivered');
                const archivedItems = allItems.filter(item => item.status === 'delivered');
                
                renderItems(activeItems);
                renderArchive(archivedItems);
                renderNotes();
                renderReports();
            }
            
            function renderItems(items) {
                const searchQuery = allElements.searchItemsInput.value.toLowerCase();
                let filteredItems = items.filter(item => item.customerName.toLowerCase().includes(searchQuery));
                
                allElements.totalBagsCounter.textContent = filteredItems.reduce((sum, item) => sum + item.bagCount, 0);

                const direction = sortState.direction === 'asc' ? 1 : -1;
                filteredItems.sort((a, b) => {
                    if (sortState.type === 'alpha') return a.customerName.localeCompare(b.customerName, 'tr') * direction;
                    if (sortState.type === 'bags') return (a.bagCount - b.bagCount) * direction;
                    
                    const dateA = a.lastModified?.seconds ? a.lastModified.seconds : new Date(a.lastModified).getTime() / 1000;
                    const dateB = b.lastModified?.seconds ? b.lastModified.seconds : new Date(b.lastModified).getTime() / 1000;
                    return (dateB - dateA) * direction;
                });
                
                allElements.itemList.innerHTML = '';
                allElements.emptyItemListMessage.style.display = filteredItems.length === 0 ? 'block' : 'none';
                allElements.emptyItemListMessage.textContent = searchQuery ? `Aramanızla eşleşen sonuç bulunamadı.` : `Henüz bekleyen poşet bulunmuyor.`;
                filteredItems.forEach(item => allElements.itemList.appendChild(createItemElement(item)));
            }
            
            function createItemElement(item) {
                const div = document.createElement('div');
                const date = item.lastModified?.seconds ? new Date(item.lastModified.seconds * 1000) : new Date();
                const diffDays = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));

                const overdueClass = (() => {
                    if (diffDays >= 15) return 'border-red-500/60 bg-red-500/10';
                    if (diffDays >= 7) return 'border-yellow-500/60 bg-yellow-500/10';
                    return 'border-dynamic';
                })();
                const noteIndicatorHTML = item.note ? `<span class="accent-text text-xs" title="Not Mevcut">●</span>` : '';
                
                div.className = `bg-primary p-4 rounded-lg shadow-md flex items-center justify-between border ${overdueClass} transition-colors duration-300`;
                div.dataset.id = item.id;
                div.innerHTML = `
                    <div class="item-details flex-1 flex items-center gap-4">
                        <div class="item-bag-count bg-purple-500/20 text-purple-300 font-bold w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full text-xl">${item.bagCount}</div>
                        <div class="flex-1">
                            <p class="item-customer-name font-semibold text-lg text-primary flex items-center gap-2">${item.customerName} ${noteIndicatorHTML}</p>
                            <p class="item-subtext text-sm text-secondary">Poşet Sayısı</p>
                            <p class="item-subtext text-xs text-secondary/70 mt-1">Son Değişiklik: ${formatRelativeTime(item.lastModified)}</p>
                        </div>
                    </div>
                    <div class="item-actions flex items-center gap-1 sm:gap-2 ml-2">
                        <button data-action="edit-count" class="p-2 text-secondary hover:accent-text rounded-full transition" title="Poşet Sayısını Düzenle"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.293z"/></svg></button>
                        <button data-action="edit-note" class="p-2 text-secondary hover:accent-text rounded-full transition ${item.note ? 'accent-text' : ''}" title="Notu Düzenle"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 12.5A.5.5 0 0 1 5 12h3.793l1.147-1.146a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .5-.5m.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1z"/><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1z"/></svg></button>
                        <button data-action="deliver" class="p-2 text-green-400 hover:text-green-300 rounded-full transition" title="Teslim Et"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg></button>
                    </div>`;
                return div;
            }
            
            function renderArchive(items) {
                const searchQuery = allElements.searchArchiveInput.value.toLowerCase();
                let filteredItems = items.filter(item => item.customerName.toLowerCase().includes(searchQuery));
                
                filteredItems.sort((a,b) => {
                    const dateA = a.deliveredAt?.seconds || 0;
                    const dateB = b.deliveredAt?.seconds || 0;
                    return dateB - dateA;
                });
                
                allElements.emptyArchiveListMessage.style.display = filteredItems.length === 0 ? 'block' : 'none';

                const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
                if(archiveCurrentPage > totalPages && totalPages > 0) archiveCurrentPage = totalPages;

                const startIndex = (archiveCurrentPage - 1) * itemsPerPage;
                const paginatedItems = filteredItems.slice(startIndex, startIndex + itemsPerPage);

                allElements.archiveList.innerHTML = '';
                paginatedItems.forEach(item => allElements.archiveList.appendChild(createArchiveItemElement(item)));

                renderArchivePagination(totalPages);
            }
            
            function createArchiveItemElement(item) {
                const div = document.createElement('div');
                div.className = 'bg-primary/50 opacity-70 p-4 rounded-lg shadow-md flex items-center justify-between border border-dynamic';
                div.dataset.id = item.id;
                div.innerHTML = `
                    <div class="item-details flex-1 flex items-center gap-4">
                        <div class="item-bag-count bg-slate-600/50 text-slate-400 font-bold w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full text-xl">${item.bagCount}</div>
                        <div class="flex-1">
                            <p class="item-customer-name font-semibold text-lg text-primary/80">${item.customerName}</p>
                            <p class="item-subtext text-sm text-secondary">Teslim Edildi: ${formatDate(item.deliveredAt)}</p>
                        </div>
                    </div>
                    <div class="item-actions flex items-center gap-2 ml-2">
                        <button data-action="restore" class="p-2 text-secondary hover:text-yellow-400 rounded-full transition" title="Geri Yükle"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg></button>
                        <button data-action="delete-permanent" class="p-2 text-secondary hover:text-red-500 rounded-full transition" title="Kalıcı Olarak Sil"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg></button>
                    </div>`;
                return div;
            }
            
            function renderNotes() {
                const itemsWithNotes = allItems.filter(item => item.note && item.note.trim() !== '').sort((a,b) => {
                    const dateA = a.lastModified?.seconds || 0;
                    const dateB = b.lastModified?.seconds || 0;
                    return dateB - dateA;
                });
                allElements.notesList.innerHTML = '';
                allElements.emptyNotesMessage.classList.toggle('hidden', itemsWithNotes.length > 0);
                itemsWithNotes.forEach(item => allElements.notesList.appendChild(createNoteElement(item)));
            }

            function createNoteElement(item) {
                const div = document.createElement('div');
                div.className = 'bg-primary p-4 rounded-lg shadow-md border border-dynamic';
                div.dataset.id = item.id;
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                         <p class="font-semibold accent-text">${item.customerName}</p>
                         <button data-action="delete-note-from-tab" class="p-1 -mt-1 -mr-1 text-secondary hover:text-red-500 rounded-full transition" title="Notu Sil">
                            <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg>
                        </button>
                    </div>
                    <p class="text-primary mt-2 whitespace-pre-wrap">${item.note}</p>
                `;
                return div;
            }
            
            function renderReports() {
                renderPeriodicReport(); 
                renderOverdueReport();
            }
            
            function renderOverdueReport() {
                const overdueList = document.getElementById('overdue-report-list');
                const overdueMessage = document.getElementById('empty-overdue-report-message');
                const activeItems = allItems.filter(item => item.status !== 'delivered');

                if (activeItems.length === 0) {
                    overdueList.innerHTML = '';
                    overdueMessage.classList.remove('hidden');
                    return;
                }
                
                overdueMessage.classList.add('hidden');
                activeItems.sort((a, b) => {
                     const dateA = a.lastModified?.seconds || 0;
                     const dateB = b.lastModified?.seconds || 0;
                     return dateA - dateB;
                });
                const top10 = activeItems.slice(0, 10);

                overdueList.innerHTML = top10.map((item, index) => {
                    return `<div class="bg-tertiary p-3 rounded-md flex justify-between items-center">
                                <span class="text-primary">${index + 1}. ${item.customerName}</span>
                                <span class="text-sm text-secondary">${formatRelativeTime(item.lastModified)}</span>
                            </div>`;
                }).join('');
            }
            
            function renderPeriodicReport(range = null) {
                const contentDiv = document.getElementById('periodic-report-content');
                if(range === null) {
                    const activeBtn = document.querySelector('.report-range-btn.accent-bg');
                    if (activeBtn) range = activeBtn.dataset.range;
                    else {
                         contentDiv.innerHTML = 'Raporu görmek için bir zaman aralığı seçin.';
                         return; 
                    }
                }
                
                let added, delivered;
                
                if (range === 'all') {
                    added = allItems.length;
                    delivered = allItems.filter(i => i.status === 'delivered').length;
                } else {
                    const rangeNum = parseInt(range, 10);
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - rangeNum);

                    added = allItems.filter(i => (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : new Date(i.createdAt)) >= startDate).length;
                    delivered = allItems.filter(i => i.status === 'delivered' && (i.deliveredAt?.seconds ? new Date(i.deliveredAt.seconds * 1000) : new Date(i.deliveredAt)) >= startDate).length;
                }

                contentDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-3xl font-bold text-green-400">${added}</p>
                            <p class="text-sm text-secondary">Yeni Poşet Eklendi</p>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-blue-400">${delivered}</p>
                            <p class="text-sm text-secondary">Poşet Teslim Edildi</p>
                        </div>
                    </div>
                `;
            }

            // --- FIRESTORE İŞLEMLERİ ---
            async function handleAddItem(e) {
                e.preventDefault();
                const customerName = allElements.customerNameInput.value.trim();
                const bagCount = parseInt(allElements.bagCountInput.value, 10);
                if (!customerName || isNaN(bagCount) || bagCount < 1) return;

                try {
                    const customerExists = allCustomers.some(c => c.name.toLowerCase() === customerName.toLowerCase());
                    if (!customerExists) {
                        await addDoc(collection(db, 'customers'), { name: customerName });
                    }

                    await addDoc(collection(db, 'items'), {
                        customerName,
                        bagCount,
                        note: '',
                        status: 'active',
                        createdAt: serverTimestamp(),
                        lastModified: serverTimestamp(),
                        deliveredAt: null
                    });

                    allElements.addItemForm.reset();
                    allElements.bagCountInput.value = 1;
                    allElements.customerNameInput.focus();

                } catch (error) {
                    console.error("Error adding document: ", error);
                    showSimpleMessageModal("Hata", "Kayıt eklenirken bir hata oluştu.");
                }
            }

            async function updateItem(id, data) {
                const itemRef = doc(db, 'items', id);
                await updateDoc(itemRef, { ...data, lastModified: serverTimestamp() });
            }

            async function deleteItem(id) {
                await deleteDoc(doc(db, 'items', id));
            }
            
            async function deleteCustomer(id) {
                // Sadece müşteri silinir, müşteriye ait poşet kayıtları etkilenmez.
                await deleteDoc(doc(db, 'customers', id));
            }
            
            async function updateCustomerNameAndItems(customerId, oldName, newName) {
                allElements.loadingText.textContent = 'Müşteri adı ve ilgili poşetler güncelleniyor...';
                allElements.loadingOverlay.style.display = 'flex';
                allElements.loadingOverlay.style.opacity = '1';
                try {
                    const batch = writeBatch(db);

                    // 1. Müşteri belgesini güncelle
                    const customerRef = doc(db, 'customers', customerId);
                    batch.update(customerRef, { name: newName });
                    
                    // 2. Eski isme sahip tüm poşetleri bul ve güncelle
                    const itemsQuery = query(collection(db, 'items'), where("customerName", "==", oldName));
                    const itemsSnapshot = await getDocs(itemsQuery);
                    itemsSnapshot.forEach(itemDoc => {
                        batch.update(itemDoc.ref, { customerName: newName });
                    });
                    
                    await batch.commit();
                } catch(error) {
                     console.error("Müşteri adı güncellenirken hata:", error);
                     showSimpleMessageModal("Hata", "Müşteri adı güncellenirken bir sorun oluştu.");
                } finally {
                    allElements.loadingOverlay.style.opacity = '0';
                    setTimeout(() => { allElements.loadingOverlay.style.display = 'none'; }, 300);
                }
            }

            async function importDataFromJSON(data) {
                if (!data.allItems || !data.allCustomers) {
                    showSimpleMessageModal('Hata', 'Geçersiz yedek dosyası formatı.');
                    return;
                }

                allElements.loadingText.textContent = 'Veriler siliniyor...';
                
                const itemsBatch = writeBatch(db);
                allItems.forEach(item => itemsBatch.delete(doc(db, 'items', item.id)));
                await itemsBatch.commit();
                
                const customersBatch = writeBatch(db);
                allCustomers.forEach(customer => customersBatch.delete(doc(db, 'customers', customer.id)));
                await customersBatch.commit();

                allElements.loadingText.textContent = 'Veriler içe aktarılıyor...';
                
                const newItemsBatch = writeBatch(db);
                data.allItems.forEach(item => {
                    const newItemRef = doc(collection(db, 'items'));
                    const cleanItem = { ...item };
                    delete cleanItem.id; 
                    if (cleanItem.createdAt) cleanItem.createdAt = new Date(cleanItem.createdAt.seconds ? cleanItem.createdAt.seconds * 1000 : cleanItem.createdAt);
                    if (cleanItem.lastModified) cleanItem.lastModified = new Date(cleanItem.lastModified.seconds ? cleanItem.lastModified.seconds * 1000 : cleanItem.lastModified);
                    if (cleanItem.deliveredAt) cleanItem.deliveredAt = new Date(cleanItem.deliveredAt.seconds ? cleanItem.deliveredAt.seconds * 1000 : cleanItem.deliveredAt);
                    newItemsBatch.set(newItemRef, cleanItem);
                });
                await newItemsBatch.commit();

                const newCustomersBatch = writeBatch(db);
                data.allCustomers.forEach(customer => {
                    const newCustomerRef = doc(collection(db, 'customers'));
                    const cleanCustomer = { ...customer };
                    delete cleanCustomer.id;
                    newCustomersBatch.set(newCustomerRef, cleanCustomer);
                });
                await newCustomersBatch.commit();

                showSimpleMessageModal('Başarılı', 'Veriler başarıyla geri yüklendi.');
            }
            
            async function resetAllData() {
                 allElements.loadingText.textContent = 'Tüm veriler siliniyor...';
                 allElements.loadingOverlay.style.display = 'flex';
                 allElements.loadingOverlay.style.opacity = '1';

                const itemsBatch = writeBatch(db);
                allItems.forEach(item => itemsBatch.delete(doc(db, 'items', item.id)));
                await itemsBatch.commit();
                
                const customersBatch = writeBatch(db);
                allCustomers.forEach(customer => customersBatch.delete(doc(db, 'customers', customer.id)));
                await customersBatch.commit();
                
                allElements.loadingOverlay.style.opacity = '0';
                setTimeout(() => { allElements.loadingOverlay.style.display = 'none'; }, 300);
            }

            // --- UYGULAMA BAŞLATMA VE VERİ DİNLEME ---
            function startFirebaseConnection() {
                clearTimeout(connectionTimeout);
                connectionTimeout = setTimeout(() => {
                    showConnectionError('Bağlantı zaman aşımına uğradı. İnternetinizi kontrol edin.');
                }, 10000); 

                try {
                    if (!app) {
                        app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                    }
                    
                    onAuthStateChanged(auth, user => {
                        clearTimeout(connectionTimeout);
                        if (user) {
                            listenToData();
                        } else {
                            signInAnonymously(auth).catch(error => {
                                console.error("Anonymous sign-in failed: ", error);
                                showConnectionError('Veritabanı ile kimlik doğrulaması yapılamadı.');
                            });
                        }
                    });
                } catch(e) {
                    clearTimeout(connectionTimeout);
                    console.error("Firebase initialization error:", e);
                    showConnectionError('Uygulama başlatılamadı. Yapılandırmayı kontrol edin.');
                }
            }

            function initialize() {
                settings = getSettingsFromStorage();
                applySettings();
                updateSortButtons();
                switchTab('list', true);
                allElements.retryButton.addEventListener('click', () => {
                    allElements.loadingText.textContent = 'Veritabanına bağlanılıyor...';
                    allElements.loadingSpinner.style.display = 'block';
                    allElements.retryContainer.classList.add('hidden');
                    startFirebaseConnection();
                });
                startFirebaseConnection();
            }

            function listenToData() {
                if (itemsUnsubscribe) itemsUnsubscribe();
                if (customersUnsubscribe) customersUnsubscribe();

                const itemsQuery = query(collection(db, "items"));
                itemsUnsubscribe = onSnapshot(itemsQuery, (snapshot) => {
                    allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAll();
                    showApp(); 
                }, error => {
                    console.error("Error listening to items: ", error);
                    showConnectionError('Veri alınırken bir hata oluştu.');
                });

                const customersQuery = query(collection(db, "customers"));
                customersUnsubscribe = onSnapshot(customersQuery, (snapshot) => {
                    allCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const modalList = document.getElementById('modal-customers-list');
                    if (modalList && !allElements.modalContainer.classList.contains('hidden')) {
                        const searchInput = document.getElementById('modal-customer-search');
                        renderCustomerModalList(searchInput?.value || '');
                    }
                }, error => console.error("Error listening to customers: ", error));
            }
            
            // --- EVENT LISTENERS ---
            allElements.addItemForm.addEventListener('submit', handleAddItem);
            
            allElements.searchItemsInput.addEventListener('input', () => renderItems(allItems.filter(item => item.status !== 'delivered')));
            allElements.searchArchiveInput.addEventListener('input', () => {
                archiveCurrentPage = 1;
                renderArchive(allItems.filter(item => item.status === 'delivered'));
            });
            allElements.sortAlphaBtn.addEventListener('click', () => handleSort('alpha'));
            allElements.sortBagsBtn.addEventListener('click', () => handleSort('bags'));
            allElements.sortDateBtn.addEventListener('click', () => handleSort('date'));

            allElements.mainContent.addEventListener('click', async (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;

                const itemDiv = button.closest('div[data-id]');
                if (!itemDiv) return;
                
                const id = itemDiv.dataset.id;
                const action = button.dataset.action;
                const item = allItems.find(i => i.id === id);
                if (!item) return;

                switch(action) {
                    case 'deliver':
                        showConfirmationModal(
                            `'${item.customerName}' adlı müşterinin poşetini teslim etmek istediğinizden emin misiniz?`,
                            () => updateItem(id, { status: 'delivered', deliveredAt: serverTimestamp() })
                        );
                        break;
                    case 'restore':
                        showConfirmationModal(
                            `'${item.customerName}' adlı kaydı bekleyenler listesine geri yüklemek istiyor musunuz?`,
                            () => updateItem(id, { status: 'active', deliveredAt: null }),
                            "Geri Yükle"
                        );
                        break;
                    case 'delete-permanent':
                        showConfirmationModal(
                            `'${item.customerName}' adlı kayıt kalıcı olarak silinecektir. Bu işlem geri alınamaz. Emin misiniz?`,
                            () => deleteItem(id),
                            "Kalıcı Olarak Sil", true
                        );
                        break;
                    case 'edit-count': {
                        const result = await showInputModal("Poşet Sayısını Düzenle", `'${item.customerName}' için yeni poşet sayısını girin:`, 'number', item.bagCount);
                        if (result.confirmed && result.value && !isNaN(result.value) && result.value > 0) {
                            updateItem(id, { bagCount: parseInt(result.value, 10) });
                        }
                        break;
                    }
                    case 'edit-note': {
                        const result = await showInputModal("Notu Düzenle", `'${item.customerName}' için not:`, 'textarea', item.note || '');
                        if (result.confirmed) {
                           updateItem(id, { note: result.value.trim() });
                        }
                        break;
                    }
                     case 'delete-note-from-tab':
                        showConfirmationModal(
                            `'${item.customerName}' adlı kaydın notunu silmek istediğinizden emin misiniz?`,
                            () => updateItem(id, { note: '' }),
                            "Notu Sil", true
                        );
                        break;
                }
            });
            
            document.querySelector('#panel-settings').addEventListener('click', async (e) => {
                 const themeBtn = e.target.closest('.theme-btn');
                 if(themeBtn) {
                     settings.theme = themeBtn.dataset.theme;
                     saveSettingsToStorage(settings);
                     applySettings();
                     return;
                 }
                 
                 const targetId = e.target.id;
                 switch(targetId) {
                    case 'manage-customers-btn':
                        showCustomerManagementModal();
                        break;
                    case 'export-json-btn':
                        exportDataToJSON();
                        break;
                    case 'import-json-btn':
                        allElements.importFileInput.click();
                        break;
                    case 'export-pdf-btn':
                        exportToPDF();
                        break;
                    case 'export-csv-btn':
                        exportToCSV();
                        break;
                    case 'reset-items-btn':
                        showConfirmationModal(
                            "Tüm bekleyen ve teslim edilen poşet kayıtlarını kalıcı olarak silmek istediğinizden emin misiniz? Müşteri listesi etkilenmeyecektir. Bu işlem geri alınamaz.",
                            async () => {
                                allElements.loadingText.textContent = 'Poşetler siliniyor...';
                                allElements.loadingOverlay.style.display = 'flex';
                                const batch = writeBatch(db);
                                allItems.forEach(item => batch.delete(doc(db, 'items', item.id)));
                                await batch.commit();
                                allElements.loadingOverlay.style.display = 'none';
                            }, "Evet, Sil", true
                        );
                        break;
                    case 'reset-all-btn':
                        showConfirmationModal(
                            "Uygulamadaki TÜM poşet ve müşteri verilerini kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.",
                            resetAllData, "EVET, TÜMÜNÜ SİL", true
                        );
                        break;
                 }
            });
            
            allElements.importFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        await showConfirmationModal(
                            "Mevcut tüm verileriniz bu yedeklemedeki verilerle değiştirilecektir. Bu işlem geri alınamaz. Emin misiniz?",
                            async () => {
                                allElements.loadingOverlay.style.display = 'flex';
                                await importDataFromJSON(data);
                                allElements.loadingOverlay.style.display = 'none';
                            }, "Onayla ve Yükle"
                        );
                    } catch (error) {
                        console.error("Import error:", error);
                        showSimpleMessageModal('Hata', 'Yedek dosyası okunurken hata oluştu.');
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            });
            
            document.getElementById('font-size-slider')?.addEventListener('input', (e) => {
                settings.fontSize = e.target.value;
                document.getElementById('font-size-preview').textContent = `${settings.fontSize}px`;
                document.body.style.fontSize = `${settings.fontSize}px`;
             });
            document.getElementById('font-size-slider')?.addEventListener('change', (e) => {
                settings.fontSize = e.target.value;
                 saveSettingsToStorage(settings);
             });
            
            document.querySelectorAll('.report-range-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.report-range-btn').forEach(b => b.classList.remove('accent-bg'));
                    btn.classList.add('accent-bg');
                    renderPeriodicReport(btn.dataset.range);
                });
            });

            document.querySelector('nav').addEventListener('click', (e) => {
                if (e.target.id && e.target.id.startsWith('tab-')) {
                    switchTab(e.target.id.replace('tab-', ''));
                }
            });

            allElements.customerNameInput.addEventListener("input", () => {
                const searchTerm = allElements.customerNameInput.value.trim().toLowerCase();
                allElements.suggestionsBox.innerHTML = "";
                if (searchTerm.length === 0) {
                    allElements.suggestionsBox.classList.add("hidden");
                    return;
                }

                const filtered = allCustomers
                    .filter(c => c.name.toLowerCase().includes(searchTerm))
                    .map(c => c.name);

                if (filtered.length > 0) {
                    filtered.forEach(name => {
                        const div = document.createElement("div");
                        div.textContent = name;
                        div.className = "p-3 hover:bg-slate-600 cursor-pointer text-primary";
                        div.addEventListener("click", () => {
                            allElements.customerNameInput.value = name;
                            allElements.suggestionsBox.classList.add("hidden");
                            allElements.bagCountInput.focus();
                        });
                        allElements.suggestionsBox.appendChild(div);
                    });
                    allElements.suggestionsBox.classList.remove("hidden");
                } else {
                    allElements.suggestionsBox.classList.add("hidden");
                }
            });

            document.addEventListener("click", (e) => {
                if (!e.target.closest('.relative')) {
                    allElements.suggestionsBox.classList.add("hidden");
                }
            });
            
            // --- MODAL, SIRALAMA VE DİĞER YARDIMCI FONKSİYONLAR ---
            function switchTab(target, instant = false) {
                const tabs = document.querySelectorAll('nav button[id^="tab-"]');
                const panels = document.querySelectorAll('.panel[id^="panel-"]');
                
                tabs.forEach(tab => tab.classList.remove('tab-active'));
                document.getElementById(`tab-${target}`).classList.add('tab-active');

                panels.forEach(panel => {
                    const isTargetPanel = panel.id === `panel-${target}`;
                    if (instant) {
                        panel.style.transition = 'none';
                        panel.classList.toggle('hidden', !isTargetPanel);
                        requestAnimationFrame(() => panel.style.transition = '');
                    } else {
                        panel.classList.toggle('hidden', !isTargetPanel);
                    }
                });
            }

            function handleSort(type) {
                if (sortState.type === type) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.type = type;
                    sortState.direction = (type === 'bags' || type === 'date') ? 'desc' : 'asc';
                }
                updateSortButtons();
                renderItems(allItems.filter(item => item.status !== 'delivered'));
            }

            function updateSortButtons() {
                [allElements.sortAlphaBtn, allElements.sortBagsBtn, allElements.sortDateBtn].forEach(btn => btn.classList.remove('sort-active'));
                const activeBtn = document.getElementById(`sort-${sortState.type}`);
                if (activeBtn) activeBtn.classList.add('sort-active');

                allElements.sortAlphaBtn.innerHTML = icons[`alpha_${sortState.type === 'alpha' ? sortState.direction : 'asc'}`];
                allElements.sortBagsBtn.innerHTML = icons[`bags_${sortState.type === 'bags' ? sortState.direction : 'desc'}`];
                allElements.sortDateBtn.innerHTML = icons[`date_${sortState.type === 'date' ? sortState.direction : 'desc'}`];
            }
            
            function renderArchivePagination(totalPages) {
                allElements.archivePagination.innerHTML = '';
                if(totalPages <= 1) return;

                const createBtn = (text, onClick, disabled = false) => {
                    const btn = document.createElement('button');
                    btn.innerHTML = text;
                    btn.className = 'pagination-btn p-2 bg-tertiary rounded-lg hover:accent-bg transition disabled:opacity-50 disabled:cursor-not-allowed';
                    btn.disabled = disabled;
                    btn.onclick = onClick;
                    return btn;
                }

                allElements.archivePagination.appendChild(createBtn('&laquo;', () => { archiveCurrentPage--; renderArchive(allItems.filter(i => i.status === 'delivered')) }, archiveCurrentPage === 1));

                for(let i = 1; i <= totalPages; i++) {
                    const pageBtn = createBtn(i, () => { archiveCurrentPage = i; renderArchive(allItems.filter(i => i.status === 'delivered')) });
                    if (i === archiveCurrentPage) pageBtn.classList.add('active');
                    allElements.archivePagination.appendChild(pageBtn);
                }

                allElements.archivePagination.appendChild(createBtn('&raquo;', () => { archiveCurrentPage++; renderArchive(allItems.filter(i => i.status === 'delivered')) }, archiveCurrentPage === totalPages));
            }
            
            function showModal(htmlContent) {
                return new Promise(resolve => {
                    allElements.modalContent.innerHTML = htmlContent;
                    
                    const modalClickListener = (e) => {
                        const button = e.target.closest('button');
                        if (!button) return;

                        const input = allElements.modalContent.querySelector('input, textarea');
                        const value = input ? input.value : true;

                        // Sadece `modal-close` veya `modal-cancel` butonlarına basıldığında listener'ı kaldır ve pencereyi kapat.
                        // Diğer butonlar (`modal-confirm` gibi) pencereyi açık bırakabilir.
                        const isClosingButton = button.id === 'modal-cancel' || button.id === 'modal-close';

                        if (isClosingButton) {
                            allElements.modalContent.removeEventListener('click', modalClickListener);
                            hideModalUI();
                            resolve({ confirmed: false });
                        } else if (button.id === 'modal-confirm') {
                             // "Onayla" butonu için `confirmed: true` ile resolve et, ama pencereyi kapatma.
                             // Kapatma işlemi, çağıran fonksiyonun sorumluluğundadır.
                             // Not: Bazı durumlarda yine de kapatmak isteyebiliriz, bu yüzden bu mantık özelleştirilebilir.
                             // Şimdilik, `showConfirmationModal` gibi fonksiyonlar kapatmayı kendileri yönetecek.
                            resolve({ confirmed: true, value });
                        }
                    };

                    allElements.modalContent.addEventListener('click', modalClickListener);

                    allElements.modalContainer.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        allElements.modalContainer.style.opacity = '1';
                        allElements.modalContentWrapper.classList.remove('scale-95', 'opacity-0');
                    });
                });
            }

            function hideModalUI() {
                allElements.modalContainer.style.opacity = '0';
                allElements.modalContentWrapper.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    allElements.modalContainer.classList.add('hidden');
                    allElements.modalContent.innerHTML = '';
                }, 300);
            }
            
            async function showSimpleMessageModal(title, message) {
                const result = await showModal(`
                    <h3 class="text-xl font-semibold mb-2 text-primary">${title}</h3>
                    <p class="text-secondary mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="modal-confirm" class="accent-bg text-white px-4 py-2 rounded-lg accent-bg-hover transition">Tamam</button>
                    </div>`);
                if(result.confirmed) {
                    hideModalUI();
                }
            }

            async function showConfirmationModal(message, onConfirm, confirmText = "Onayla", isDestructive = false) {
                const confirmClass = isDestructive ? 'bg-red-600 hover:bg-red-700' : 'accent-bg accent-bg-hover';
                const result = await showModal(`
                    <h3 class="text-xl font-semibold mb-2 ${isDestructive ? 'text-red-400' : 'text-primary'}">Onay</h3>
                    <p class="text-secondary mb-4">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="modal-cancel" class="bg-tertiary px-4 py-2 rounded-lg hover:bg-slate-500 transition">İptal</button>
                        <button id="modal-confirm" class="${confirmClass} text-white px-4 py-2 rounded-lg transition">${confirmText}</button>
                    </div>`);
                
                if (result.confirmed) {
                    await onConfirm();
                }
                // Her durumda modal'ı kapat
                hideModalUI();
            }

            async function showInputModal(title, message, type = 'text', value = '') {
                const inputHtml = type === 'textarea'
                    ? `<textarea class="w-full p-2 bg-tertiary border border-dynamic rounded-lg focus:ring-2 ring-accent transition h-28 mb-4">${value}</textarea>`
                    : `<input type="${type}" value="${value}" class="w-full p-2 bg-tertiary border border-dynamic rounded-lg focus:ring-2 ring-accent transition mb-4">`;

                const result = await showModal(`
                    <h3 class="text-xl font-semibold mb-2 text-primary">${title}</h3>
                    <p class="text-secondary mb-2">${message}</p>
                    ${inputHtml}
                    <div class="flex justify-end gap-3">
                        <button id="modal-cancel" class="bg-tertiary px-4 py-2 rounded-lg hover:bg-slate-500 transition">İptal</button>
                        <button id="modal-confirm" class="accent-bg text-white px-4 py-2 rounded-lg accent-bg-hover transition">Kaydet</button>
                    </div>`);
                
                if (result.confirmed || result.confirmed === false) {
                     hideModalUI();
                }
                return result;
            }

            function renderCustomerModalList(filter = '') {
                const listContainer = document.getElementById('modal-customers-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const filtered = allCustomers
                    .filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
                    .sort((a, b) => a.name.localeCompare(b.name, 'tr'));

                if(filtered.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-secondary">Müşteri bulunamadı.</p>';
                    return;
                }

                filtered.forEach(customer => {
                    const div = document.createElement('div');
                    div.className = 'p-2 bg-tertiary/50 rounded-md';
                    div.dataset.customerId = customer.id;
                    div.dataset.customerName = customer.name; // Orijinal ismi sakla
                    div.innerHTML = `
                        <!-- Varsayılan Görünüm -->
                        <div class="customer-display flex justify-between items-center">
                            <span class="customer-name-text text-primary text-sm">${customer.name}</span>
                            <div class="flex items-center gap-2">
                                <button data-cust-action="edit" class="p-1 text-secondary hover:text-yellow-400 transition" title="Düzenle">${icons.edit}</button>
                                <button data-cust-action="delete" class="p-1 text-secondary hover:text-red-500 transition" title="Sil">${icons.delete}</button>
                            </div>
                        </div>
                        <!-- Düzenleme Görünümü -->
                        <div class="customer-edit hidden flex items-center gap-2">
                            <input type="text" value="${customer.name}" class="customer-name-input flex-grow p-1 bg-secondary border border-dynamic text-primary rounded-md text-sm focus:ring-1 ring-accent transition">
                             <div class="flex items-center gap-1">
                                <button data-cust-action="save-edit" class="p-1 text-green-400 hover:text-green-300 transition" title="Kaydet">${icons.save}</button>
                                <button data-cust-action="cancel-edit" class="p-1 text-red-500 hover:text-red-400 transition" title="İptal">${icons.cancel}</button>
                            </div>
                        </div>
                        <!-- Silme Onayı Görünümü -->
                        <div class="customer-delete-confirm hidden flex justify-between items-center">
                            <span class="text-red-300 text-sm">Silinsin mi?</span>
                            <div class="flex items-center gap-2">
                                <button data-cust-action="confirm-delete" class="text-sm bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Evet</button>
                                <button data-cust-action="cancel-delete" class="text-sm bg-tertiary px-2 py-1 rounded-md hover:bg-slate-500">Hayır</button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
            
            async function showCustomerManagementModal() {
                 showModal(`
                    <div class="flex flex-col h-[70vh]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-primary">Müşteri Listesi</h3>
                            <button id="modal-close" class="p-1 text-secondary hover:text-primary transition">${icons.cancel}</button>
                        </div>
                        <div id="modal-customer-error" class="hidden text-center p-2 mb-2 bg-red-500/20 text-red-300 rounded-md text-sm"></div>
                        <form id="modal-add-customer-form" class="flex gap-2 mb-4">
                            <input type="text" id="modal-new-customer-name" placeholder="Yeni Müşteri Ekle" class="flex-grow p-2 bg-secondary border border-dynamic text-primary rounded-lg focus:ring-2 ring-accent transition" required>
                            <button type="submit" class="accent-bg text-white font-semibold px-4 rounded-lg accent-bg-hover transition">Ekle</button>
                        </form>
                        <input type="search" id="modal-customer-search" placeholder="Müşteri ara..." class="w-full p-2 mb-4 bg-secondary border border-dynamic rounded-lg focus:ring-2 ring-accent transition">
                        <div id="modal-customers-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                    </div>
                `);

                await new Promise(resolve => setTimeout(resolve, 0));
                
                const listContainer = document.getElementById('modal-customers-list');
                const searchInput = document.getElementById('modal-customer-search');
                const addForm = document.getElementById('modal-add-customer-form');
                const addInput = document.getElementById('modal-new-customer-name');
                const errorDiv = document.getElementById('modal-customer-error');

                function showModalError(message) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('hidden');
                    setTimeout(() => errorDiv.classList.add('hidden'), 3000);
                }

                searchInput.addEventListener('input', () => renderCustomerModalList(searchInput.value));
                
                listContainer.addEventListener('click', async e => {
                    const button = e.target.closest('button[data-cust-action]');
                    if (!button) return;

                    const action = button.dataset.custAction;
                    const customerDiv = button.closest('div[data-customer-id]');
                    const customerId = customerDiv.dataset.customerId;

                    const displayView = customerDiv.querySelector('.customer-display');
                    const editView = customerDiv.querySelector('.customer-edit');
                    const deleteConfirmView = customerDiv.querySelector('.customer-delete-confirm');

                    switch (action) {
                        case 'delete':
                            displayView.classList.add('hidden');
                            deleteConfirmView.classList.remove('hidden');
                            break;
                        case 'cancel-delete':
                            deleteConfirmView.classList.add('hidden');
                            displayView.classList.remove('hidden');
                            break;
                        case 'confirm-delete':
                            await deleteCustomer(customerId);
                            // onSnapshot will auto-refresh the list
                            break;
                        case 'edit':
                            displayView.classList.add('hidden');
                            editView.classList.remove('hidden');
                            editView.querySelector('input').focus();
                            break;
                        case 'cancel-edit':
                            editView.classList.add('hidden');
                            displayView.classList.remove('hidden');
                            break;
                        case 'save-edit':
                            const input = editView.querySelector('.customer-name-input');
                            const newName = input.value.trim();
                            const oldName = customerDiv.dataset.customerName;

                            if (!newName) {
                                showModalError("Müşteri adı boş olamaz.");
                                return;
                            }
                            if (newName.toLowerCase() === oldName.toLowerCase()) {
                                // No change, just revert the view
                                editView.classList.add('hidden');
                                displayView.classList.remove('hidden');
                                return;
                            }
                            const isDuplicate = allCustomers.some(c => c.name.toLowerCase() === newName.toLowerCase() && c.id !== customerId);
                            if (isDuplicate) {
                                showModalError("Bu isimde başka bir müşteri zaten var.");
                                return;
                            }
                            
                            await updateCustomerNameAndItems(customerId, oldName, newName);
                            // onSnapshot will handle the UI update.
                            break;
                    }
                });
                
                addForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const name = addInput.value.trim();
                    if (name && !allCustomers.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                       await addDoc(collection(db, 'customers'), { name });
                       addInput.value = '';
                    } else if (name) {
                       showModalError('Bu müşteri zaten mevcut.');
                    }
                });
                
                renderCustomerModalList();
            }
            
            function exportDataToJSON() {
                const data = { allItems, allCustomers, settings };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `poset-takip-yedek-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function exportToCSV() {
                const activeItems = allItems.filter(item => item.status !== 'delivered');
                if (activeItems.length === 0) { showSimpleMessageModal("Bilgi", "Dışa aktarılacak veri yok."); return; }
                
                const headers = "Musteri Adi,Poset Sayisi,Not,Son Degisiklik Tarihi";
                const rows = activeItems.map(item =>
                    `"${item.customerName.replace(/"/g, '""')}",${item.bagCount},"${(item.note || '').replace(/"/g, '""')}",${formatDate(item.lastModified)}`
                );

                const csvContent = "\uFEFF" + [headers, ...rows].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "poset_listesi.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportToPDF() {
                const activeItems = allItems.filter(item => item.status !== 'delivered');
                 if (activeItems.length === 0) { showSimpleMessageModal("Bilgi", "Dışa aktarılacak veri yok."); return; }

                const pdf = new jsPDF();
                pdf.text("Bekleyen Poşet Listesi", 14, 16);
                
                const tableColumn = ["#", "Musteri Adi", "Poset Sayisi", "Tarih"];
                const tableRows = [];

                activeItems.forEach((item, index) => {
                    tableRows.push([
                        index + 1,
                        item.customerName,
                        item.bagCount,
                        formatDate(item.lastModified).split(' ')[0]
                    ]);
                });

                pdf.autoTable({
                    head: [tableColumn], body: tableRows, startY: 20,
                });

                pdf.save('poset_listesi.pdf');
            }

            // --- UYGULAMAYI BAŞLAT ---
            initialize();
        });
    </script>
    
    <!-- PWA Service Worker Kaydı -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
