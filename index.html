<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emre Bebe Toptan Müşteri Poşet Takibi (Bulut Tabanlı)</title>
    <meta name="description" content="Emre Bebe Toptan Müşteri Poşet Takip Uygulaması">

    <meta name="theme-color" content="#1e293b"/>
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/1e293b/ffffff?text=ET">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Genel Stil ve Geçişler */
        :root {
            --bg-primary: #1e293b; /* bg-slate-800 */
            --bg-secondary: #0f172a; /* bg-slate-900 */
            --bg-tertiary: #334155; /* bg-slate-700 */
            --text-primary: #cbd5e1; /* text-slate-300 */
            --text-secondary: #94a3b8; /* text-slate-400 */
            --border-color: #475569; /* border-slate-600 */
            --accent-color: #a78bfa; /* purple-400 */
            --accent-color-dark: #8b5cf6; /* purple-600 */
            --font-size-base: 16px;
        }

        .theme-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --accent-color: #8b5cf6;
            --accent-color-dark: #7c3aed;
        }

        .theme-night-blue {
            --bg-primary: #1c2a4a;
            --bg-secondary: #0d1a33;
            --bg-tertiary: #2a3a5a;
            --text-primary: #e0e7ff;
            --text-secondary: #a0b3d4;
            --border-color: #3a4a6a;
            --accent-color: #7aa2f7;
            --accent-color-dark: #5a82e7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Otomatik büyük harf için stil */
        input[type="text"], input[type="search"], textarea {
            text-transform: uppercase;
        }

        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-dynamic { border-color: var(--border-color); }
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color-dark); }
        .accent-bg-hover:hover { background-color: var(--accent-color); }
        .ring-accent:focus { --tw-ring-color: var(--accent-color); }
        
        .tab-active { border-color: var(--accent-color) !important; color: var(--text-primary) !important; }
        .sort-active { background-color: var(--bg-tertiary); color: var(--text-primary); }

        .panel { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; will-change: opacity, transform; }
        .panel.hidden { opacity: 0; transform: translateY(10px); pointer-events: none; position: absolute; width: 100%; }
        
        #modal-container.hidden { pointer-events: none; opacity: 0; }
        #modal-content-wrapper.hidden { transform: scale(0.95); opacity: 0; }
        .pagination-btn { min-width: 2.5rem; }
        .pagination-btn.active { background-color: var(--accent-color-dark); color: white; font-weight: bold; }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.9);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            color: var(--text-primary);
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body class="bg-secondary text-primary">

    <div id="loading-overlay">
        <div id="loading-spinner">
            <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <p id="loading-text">Veritabanına bağlanılıyor...</p>
        <div id="retry-container" class="hidden mt-4">
            <button id="retry-button" class="accent-bg text-white font-semibold py-2 px-4 rounded-lg accent-bg-hover transition">Yeniden Dene</button>
        </div>
    </div>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8 min-h-screen opacity-0 transition-opacity duration-500">
        
        <header class="relative text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-primary">Emre Bebe Toptan Müşteri Poşet Takibi</h1>
            <p class="mt-2 text-secondary">Tüm Ayrılan Poşetleri tek yerden yönetin.</p>
            <div class="absolute top-0 right-0">
                <button id="notification-bell" class="relative p-2 text-slate-400 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg>
                    <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center"></span>
                </button>
            </div>
        </header>

        <div class="mb-6 border-b border-dynamic">
            <nav class="-mb-px flex space-x-2 sm:space-x-6 overflow-x-auto" aria-label="Tabs">
                <button id="tab-list" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Liste</button>
                <button id="tab-archive" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Teslim Edilenler</button>
                <button id="tab-reports" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Raporlar</button>
                <button id="tab-notes" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Notlarım</button>
                <button id="tab-settings" class="whitespace-nowrap py-4 px-2 sm:px-4 border-b-2 font-medium text-lg border-transparent text-secondary hover:text-primary hover:border-gray-500">Ayarlar</button>
            </nav>
        </div>

        <main id="main-content" class="relative">
            <div id="panel-list" class="panel space-y-8">
                 <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">Yeni Poşet Ekle / Listede Ara</h2>
                    <form id="add-item-form" class="grid grid-cols-1 sm:grid-cols-5 gap-4">
                        <div class="relative sm:col-span-3">
                            <input type="text" id="customer-name" placeholder="Müşteri Adı / Listede Ara..." class="w-full p-3 bg-tertiary border border-dynamic text-primary rounded-lg focus:ring-2 ring-accent transition" required autocomplete="off">
                            <button type="button" id="clear-customer-name" class="hidden absolute inset-y-0 right-0 pr-3 flex items-center text-secondary hover:text-primary">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                            <div id="suggestions-box" class="hidden absolute top-full left-0 right-0 z-20 bg-tertiary border border-t-0 border-dynamic rounded-b-lg shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>
                        <input type="number" id="bag-count" placeholder="Poşet Sayısı" value="1" min="1" class="sm:col-span-1 w-full p-3 bg-tertiary border border-dynamic text-primary rounded-lg focus:ring-2 ring-accent transition" required>
                        <button type="submit" class="sm:col-span-1 w-full accent-bg text-white font-semibold p-3 rounded-lg accent-bg-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-secondary ring-accent transition-all">Ekle</button>
                    </form>
                </div>
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-3">
                            <h2 class="text-2xl font-semibold text-primary">Bekleyen Poşetler</h2>
                            <span id="total-customers-counter" class="text-base font-medium bg-sky-500/20 text-sky-300 py-1 px-3 rounded-full" title="Bekleyen Müşteri Sayısı"></span>
                            <span id="total-bags-counter" class="text-base font-medium bg-purple-500/20 text-purple-300 py-1 px-3 rounded-full" title="Toplam Poşet Sayısı"></span>
                        </div>
                        <div class="flex items-center gap-2">
                             <div class="flex border border-dynamic rounded-lg">
                                <button id="sort-alpha" class="p-2 text-secondary hover:bg-tertiary rounded-l-md" title="Alfabetik Sırala"></button>
                                <button id="sort-bags" class="p-2 text-secondary hover:bg-tertiary border-l border-dynamic" title="Poşet Sayısına Göre Sırala"></button>
                                <button id="sort-date" class="p-2 text-secondary hover:bg-tertiary border-l border-dynamic rounded-r-md" title="Tarihe Göre Sırala"></button>
                            </div>
                        </div>
                    </div>
                    <div id="item-list" class="space-y-2"></div>
                    <p id="empty-item-list-message" class="hidden text-center text-secondary bg-primary border border-dynamic p-6 rounded-xl shadow-lg">Henüz bekleyen poşet bulunmuyor.</p>
                </div>
            </div>

            <div id="panel-archive" class="panel hidden space-y-4">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-primary">Teslim Edilenler Arşivi</h2>
                     <div class="flex items-center gap-2">
                        <input type="search" id="search-archive-input" placeholder="Arşivde ara..." class="p-2 bg-tertiary border border-dynamic rounded-lg focus:ring-2 ring-accent transition w-full sm:w-auto">
                        <button id="export-archive-pdf-btn" class="p-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition" title="Arşivi PDF Olarak Aktar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                        </button>
                    </div>
                </div>
                <div id="archive-list" class="space-y-2"></div>
                <div id="archive-pagination" class="flex justify-center items-center mt-4 space-x-2"></div>
                <p id="empty-archive-list-message" class="hidden text-center text-secondary bg-primary border border-dynamic p-6 rounded-xl shadow-lg">Arşivde hiç kayıt bulunmuyor.</p>
            </div>
            
            <div id="panel-reports" class="panel hidden space-y-8">
                 <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">Dönemsel Raporlar</h2>
                    <div class="flex gap-2 mb-4">
                        <button data-range="7" class="report-range-btn flex-1 bg-tertiary p-2 rounded-lg hover:bg-purple-500/30">Son 7 Gün</button>
                        <button data-range="30" class="report-range-btn flex-1 bg-tertiary p-2 rounded-lg hover:bg-purple-500/30">Son 30 Gün</button>
                        <button data-range="all" class="report-range-btn flex-1 bg-tertiary p-2 rounded-lg hover:bg-purple-500/30">Tüm Zamanlar</button>
                    </div>
                    <div id="periodic-report-content" class="text-center p-4 bg-secondary rounded-lg border border-dynamic">
                        Raporu görmek için bir zaman aralığı seçin.
                    </div>
                </div>
                 <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">En Uzun Süredir Bekleyen 10 Poşet</h2>
                    <div id="overdue-report-list" class="space-y-2"></div>
                     <p id="empty-overdue-report-message" class="hidden text-center text-secondary p-4">Tüm poşetler teslim edilmiş veya yeni.</p>
                </div>
                 <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">Raporları Aktar</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="export-reports-pdf-btn" class="flex-1 bg-rose-600 text-white font-semibold p-3 rounded-lg hover:bg-rose-700 transition">Teslim Edilenler Raporu (PDF)</button>
                    </div>
                    <p class="text-xs text-secondary mt-3">Teslim edilen tüm poşetlerin alınma, teslim edilme ve bekleme sürelerini içeren detaylı bir PDF raporu oluşturur.</p>
                </div>
            </div>

            <div id="panel-notes" class="panel hidden space-y-4">
                <h2 class="text-2xl font-semibold text-primary">Tüm Notlar</h2>
                <div id="notes-list" class="space-y-2"></div>
                <p id="empty-notes-message" class="hidden text-center text-secondary bg-primary border border-dynamic p-6 rounded-xl shadow-lg">Henüz not eklenmiş bir kayıt bulunmuyor.</p>
            </div>

            <div id="panel-settings" class="panel hidden space-y-8">
                <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic space-y-6">
                    <h2 class="text-2xl font-semibold text-primary">Görünüm Ayarları</h2>
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Tema</h3>
                        <div class="flex gap-2">
                            <button data-theme="dark" class="theme-btn flex-1 p-2 rounded-lg border-2 border-slate-700 bg-slate-800 text-slate-300">Varsayılan</button>
                            <button data-theme="light" class="theme-btn flex-1 p-2 rounded-lg border-2 border-gray-300 bg-white text-black">Açık</button>
                            <button data-theme="night-blue" class="theme-btn flex-1 p-2 rounded-lg border-2 border-indigo-900 bg-blue-950 text-blue-200">Gece Mavisi</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Yazı Tipi Boyutu (<span id="font-size-preview">16px</span>)</h3>
                        <input type="range" id="font-size-slider" min="12" max="20" step="1" value="16" class="w-full h-2 bg-tertiary rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic space-y-6">
                    <h2 class="text-2xl font-semibold text-primary">Müşteri Yönetimi</h2>
                    <div>
                        <h3 class="text-lg font-medium text-primary mb-2">Müşteri Listesi Yönetimi</h3>
                        <button id="manage-customers-btn" class="w-full bg-tertiary text-primary font-semibold p-3 rounded-lg hover:bg-slate-600 transition-all">
                            Müşteri Listesini Görüntüle ve Yönet
                        </button>
                    </div>
                </div>
                
                <div class="bg-primary p-6 rounded-xl shadow-lg border border-dynamic space-y-6">
                    <h2 class="text-2xl font-semibold text-primary">Veri Yönetimi</h2>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="export-json-btn" class="w-full bg-sky-600 text-white font-semibold p-3 rounded-lg hover:bg-sky-700 transition">Yedekle (JSON)</button>
                        <button id="import-json-btn" class="w-full bg-teal-600 text-white font-semibold p-3 rounded-lg hover:bg-teal-700 transition">Geri Yükle (JSON)</button>
                        <button id="export-active-pdf-btn" class="w-full bg-rose-600 text-white font-semibold p-3 rounded-lg hover:bg-rose-700 transition">Bekleyen Listeyi PDF Aktar</button>
                        <button id="export-csv-btn" class="w-full bg-emerald-600 text-white font-semibold p-3 rounded-lg hover:bg-emerald-700 transition">Listeyi CSV Aktar</button>
                         <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                    <div>
                         <h3 class="text-lg font-medium text-red-400 mb-2">Tehlikeli Alan</h3>
                         <div class="p-4 border border-red-500/30 bg-red-500/10 rounded-lg space-y-3">
                            <p class="text-sm text-red-300">Bu işlemler geri alınamaz. Lütfen dikkatli olun.</p>
                             <button id="reset-items-btn" class="w-full bg-red-700 text-white font-semibold p-2 rounded-lg hover:bg-red-800 transition">Sadece Poşet Listesini Sıfırla</button>
                            <button id="reset-all-btn" class="w-full bg-red-600 text-white font-bold p-3 rounded-lg hover:bg-red-700 transition">TÜM VERİLERİ SIFIRLA</button>
                         </div>
                    </div>
                </div>
                 <div class="text-center mt-4 mb-4">
                    <p class="text-xs text-secondary">Program yapımcısı Muhammed Ali KOÇ</p>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="modal-content-wrapper" class="bg-primary border border-dynamic rounded-lg shadow-xl p-6 w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0">
             <div id="modal-content"></div>
        </div>
    </div>
    
    <script type="module">
        // Firebase Modüllerini İçe Aktar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, 
            onSnapshot, query, where, serverTimestamp, writeBatch, arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- FIREBASE YAPILANDIRMASI ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsIDN74rIPhYtdaTIkeGcrczxQEjr7-sw",
            authDomain: "emre-bebe-takip.firebaseapp.com",
            projectId: "emre-bebe-takip",
            storageBucket: "emre-bebe-takip.firebasestorage.app",
            messagingSenderId: "174642780473",
            appId: "1:174642780473:web:89c50d5f80612c16e3f0e8"
        };
        
        // Gerekli kütüphaneleri yükle
        const { jsPDF } = window.jspdf;
        
        // --- UYGULAMA MANTIĞI ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTLERİ ---
            const allElements = {
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingSpinner: document.getElementById('loading-spinner'),
                loadingText: document.getElementById('loading-text'),
                retryContainer: document.getElementById('retry-container'),
                retryButton: document.getElementById('retry-button'),
                appContainer: document.getElementById('app-container'),
                mainContent: document.getElementById('main-content'),
                itemList: document.getElementById('item-list'),
                emptyItemListMessage: document.getElementById('empty-item-list-message'),
                totalBagsCounter: document.getElementById('total-bags-counter'),
                totalCustomersCounter: document.getElementById('total-customers-counter'),
                sortAlphaBtn: document.getElementById('sort-alpha'),
                sortBagsBtn: document.getElementById('sort-bags'),
                sortDateBtn: document.getElementById('sort-date'),
                addItemForm: document.getElementById('add-item-form'),
                customerNameInput: document.getElementById('customer-name'),
                bagCountInput: document.getElementById('bag-count'),
                suggestionsBox: document.getElementById('suggestions-box'),
                archiveList: document.getElementById('archive-list'),
                emptyArchiveListMessage: document.getElementById('empty-archive-list-message'),
                searchArchiveInput: document.getElementById('search-archive-input'),
                archivePagination: document.getElementById('archive-pagination'),
                notesList: document.getElementById('notes-list'),
                emptyNotesMessage: document.getElementById('empty-notes-message'),
                manageCustomersBtn: document.getElementById('manage-customers-btn'),
                exportJsonBtn: document.getElementById('export-json-btn'),
                importJsonBtn: document.getElementById('import-json-btn'),
                importFileInput: document.getElementById('import-file-input'),
                resetItemsBtn: document.getElementById('reset-items-btn'),
                resetAllBtn: document.getElementById('reset-all-btn'),
                modalContainer: document.getElementById('modal-container'),
                modalContentWrapper: document.getElementById('modal-content-wrapper'),
                modalContent: document.getElementById('modal-content'),
                exportArchivePdfBtn: document.getElementById('export-archive-pdf-btn'),
                exportReportsPdfBtn: document.getElementById('export-reports-pdf-btn'),
                exportActivePdfBtn: document.getElementById('export-active-pdf-btn'),
                notificationBell: document.getElementById('notification-bell'),
                notificationBadge: document.getElementById('notification-badge'),
                clearCustomerNameBtn: document.getElementById('clear-customer-name'),
            };

            // --- STATE (DURUM) YÖNETİMİ ---
            let app, auth, db;
            let allItems = [];
            let allCustomers = [];
            let settings = {};
            let sortState = { type: 'alpha', direction: 'asc' }; // Varsayılan sıralama: A'dan Z'ye
            let archiveCurrentPage = 1;
            const itemsPerPage = 10;
            let itemsUnsubscribe = null;
            let customersUnsubscribe = null;
            let connectionTimeout = null;
            let isAppInitialized = false;
            let seenNotifications = []; // Tek bir "görüldü" dizisi
            let customerDetailCurrentPage = 1;
            const customerDetailItemsPerPage = 5;


            // --- İKONLAR ---
            const icons = {
                alpha_asc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.082 12.629 9.664 14H8.598l1.789-5.332h1.234L13.402 14h-1.12l-.419-1.371h-1.781zm1.57-1.055h-1.296l.648-2.042.648 2.042z"/><path d="M12.96 7.022c.16-.21.283-.417.371-.622h.043c.09.205.214.412.375.622L15.04 8.5h-1.2l-.71-1.258h-.043l-.71 1.258h-1.21l1.83-3.05zM4.5 2.5a.5.5 0 0 0-1 0v9.793l-1.146-1.147a.5.5 0 0 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L4.5 12.293V2.5z"/></svg>',
                alpha_desc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.082 3.629 9.664 2H8.598l1.789 5.332h1.234L13.402 2h-1.12l-.419 1.371h-1.781zm1.57 1.055h-1.296l.648 2.042.648 2.042z"/><path d="M12.96 10.022c.16.21.283-.417.371.622h.043c.09-.205.214-.412.375-.622L15.04 8.5h-1.2l-.71 1.258h-.043l-.71-1.258h-1.21l1.83 3.05zM4.5 13.5a.5.5 0 0 1-1 0V3.707L2.354 4.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L4.5 3.707V13.5z"/></svg>',
                bags_desc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11.5 2.707V14.5a.5.5 0 0 0 .5.5z"/><path fill-rule="evenodd" d="M2.5 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/></svg>',
                bags_asc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L11.5 13.293V1.5a.5.5 0 0 1 .5-.5z"/><path fill-rule="evenodd" d="M2.5 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-1 0v-13a.5.5 0 0 1 .5-.5z"/></svg>',
                date_desc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg>',
                date_asc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 8.854a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0l-1.5 1.5a.5.5 0 0 0 .708.708L7.5 6.707l2.646 2.647a.5.5 0 0 0 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg>',
                cancel_item: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg>',
                edit: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.293z"/></svg>',
                delete: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg>',
                save: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg>',
                cancel: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/></svg>',
            };

            // --- YARDIMCI FONKSİYONLAR ---
            const toTrUpperCase = (str) => {
                if (typeof str !== 'string') return '';
                return str.toLocaleUpperCase('tr-TR');
            }
            const getSettingsFromStorage = () => JSON.parse(localStorage.getItem('emanet-settings-v2')) || { theme: 'dark', fontSize: 16 };
            const saveSettingsToStorage = (settings) => localStorage.setItem('emanet-settings-v2', JSON.stringify(settings));
            const formatDate = (iso) => {
                if(!iso) return '';
                const date = iso.seconds ? new Date(iso.seconds * 1000) : new Date(iso);
                return date.toLocaleString('tr-TR', { dateStyle: 'short', timeStyle: 'short'});
            };
            const formatRelativeTime = (iso) => {
                if (!iso) return '';
                const date = iso.seconds ? new Date(iso.seconds * 1000) : new Date(iso);
                const now = new Date();
                const diffDays = Math.floor((now.setHours(0,0,0,0) - date.setHours(0,0,0,0)) / (1000 * 60 * 60 * 24));
                if (diffDays < 0) return 'gelecekte';
                if (diffDays === 0) return 'bugün';
                if (diffDays === 1) return 'dün';
                return `${diffDays} gün önce`;
            };
            
            function getDayDifference(date1, date2) {
                if (!date1 || !date2) return '-';
                const d1 = date1.seconds ? new Date(date1.seconds * 1000) : new Date(date1);
                const d2 = date2.seconds ? new Date(date2.seconds * 1000) : new Date(date2);
                const difference = d2.getTime() - d1.getTime();
                const days = Math.ceil(difference / (1000 * 3600 * 24));
                return days >= 0 ? days : '-';
            }

            function showApp() {
                if (isAppInitialized) return;
                isAppInitialized = true;
                clearTimeout(connectionTimeout);
                allElements.loadingOverlay.style.opacity = '0';
                allElements.appContainer.style.opacity = '1';
                setTimeout(() => { allElements.loadingOverlay.style.display = 'none'; }, 300);
            }

            function showConnectionError(message) {
                clearTimeout(connectionTimeout);
                allElements.loadingSpinner.style.display = 'none';
                allElements.retryContainer.classList.remove('hidden');
                allElements.loadingText.innerHTML = `<span class="text-red-400 font-semibold">${message}</span>`;
            }

            // --- AYARLAR ---
            function applySettings() {
                document.body.className = `theme-${settings.theme} text-primary`;
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.toggle('ring-2', btn.dataset.theme === settings.theme);
                    btn.classList.toggle('ring-accent', btn.dataset.theme === settings.theme);
                });

                document.body.style.fontSize = `${settings.fontSize}px`;
                const fontSizeSlider = document.getElementById('font-size-slider');
                const fontSizePreview = document.getElementById('font-size-preview');
                if(fontSizeSlider) fontSizeSlider.value = settings.fontSize;
                if(fontSizePreview) fontSizePreview.textContent = `${settings.fontSize}px`;
            }

            // --- RENDER FONKSİYONLARI ---
            function renderAll() {
                const activeItems = allItems.filter(item => item.status !== 'delivered');
                const archivedItems = allItems.filter(item => item.status === 'delivered');
                
                renderItems(activeItems);
                renderArchive(archivedItems);
                renderNotes();
                renderReports();
                checkAndDisplayNotifications();
            }
            
            function renderItems(items) {
                const searchQuery = toTrUpperCase(allElements.customerNameInput.value);
                let filteredItems = items.filter(item => toTrUpperCase(item.customerName).includes(searchQuery));
                
                allElements.totalBagsCounter.textContent = filteredItems.reduce((sum, item) => sum + item.bagCount, 0);
                const customerNames = new Set(filteredItems.map(item => item.customerName));
                allElements.totalCustomersCounter.textContent = customerNames.size;

                const direction = sortState.direction === 'asc' ? 1 : -1;
                filteredItems.sort((a, b) => {
                    if (sortState.type === 'alpha') return a.customerName.localeCompare(b.customerName, 'tr') * direction;
                    if (sortState.type === 'bags') return (a.bagCount - b.bagCount) * direction;
                    
                    // Tarih sıralaması için `createdAt` (eklenme tarihi) kullanılır.
                    const dateA = a.createdAt?.seconds ? a.createdAt.seconds : new Date(a.createdAt || 0).getTime();
                    const dateB = b.createdAt?.seconds ? b.createdAt.seconds : new Date(b.createdAt || 0).getTime();
                    return (dateB - dateA) * direction; // dateB - dateA = en yeni en üstte (desc)
                });
                
                allElements.itemList.innerHTML = '';
                allElements.emptyItemListMessage.style.display = filteredItems.length === 0 ? 'block' : 'none';
                allElements.emptyItemListMessage.textContent = searchQuery ? `"${searchQuery}" İLE EŞLEŞEN SONUÇ BULUNAMADI.` : `HENÜZ BEKLEYEN POŞET BULUNMUYOR.`;
                filteredItems.forEach(item => allElements.itemList.appendChild(createItemElement(item)));
            }
            
            function createItemElement(item) {
                const div = document.createElement('div');
                const date = item.lastModified?.seconds ? new Date(item.lastModified.seconds * 1000) : new Date();
                const diffDays = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));

                const overdueClass = (() => {
                    if (diffDays >= 20) return 'border-red-500/60 bg-red-500/10';
                    if (diffDays >= 10) return 'border-yellow-500/60 bg-yellow-500/10';
                    return 'border-dynamic';
                })();
                let noteIndicatorHTML = '';
                if(item.note) {
                    noteIndicatorHTML += `<span class="accent-text text-xs" title="Not Mevcut">●</span>`;
                }
                if(item.reminderDate) {
                     noteIndicatorHTML += `<span class="text-cyan-400 text-xs ml-1" title="Hatırlatıcı: ${item.reminderDate}">🔔</span>`;
                }

                
                let historyHtml = '';
                // Ana oluşturma tarihi satırı
                if (item.createdAt) {
                    historyHtml += `<p class="item-subtext text-sm text-secondary">Eklendi: ${formatDate(item.createdAt).split(' ')[0]} (${formatRelativeTime(item.createdAt)})</p>`;
                } else {
                    historyHtml += '<p class="item-subtext text-sm text-secondary">Eklenme tarihi yok</p>';
                }

                // Sonraki ekleme satırları
                if (item.additionalDates && Array.isArray(item.additionalDates) && item.additionalDates.length > 0) {
                    const otherAdditions = item.additionalDates.map(date => {
                        return `<p class="item-subtext text-xs text-secondary/80 pl-2">+ Poşet Eklendi: ${formatDate(date).split(' ')[0]} (${formatRelativeTime(date)})</p>`;
                    }).join('');
                    historyHtml += otherAdditions;
                }
                
                div.className = `bg-primary p-4 rounded-lg shadow-md flex items-center justify-between border ${overdueClass} transition-colors duration-300`;
                div.dataset.id = item.id;
                div.dataset.customerName = item.customerName;
                div.innerHTML = `
                    <div class="item-details flex-1 flex items-center gap-4">
                        <div class="item-bag-count bg-purple-500/20 text-purple-300 font-bold w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full text-xl">${item.bagCount}</div>
                        <div class="flex-1">
                            <button data-action="view-customer" class="item-customer-name font-semibold text-lg text-primary text-left flex items-center gap-2 hover:underline">${item.customerName} ${noteIndicatorHTML}</button>
                            ${historyHtml}
                        </div>
                    </div>
                    <div class="item-actions flex items-center gap-1 sm:gap-2 ml-2">
                        <div class="default-actions flex items-center gap-1 sm:gap-2">
                            <button data-action="edit-count" class="p-2 text-secondary hover:accent-text rounded-full transition" title="Poşet Sayısını Düzenle">${icons.edit}</button>
                            <button data-action="edit-note" class="p-2 text-secondary hover:accent-text rounded-full transition ${item.note || item.reminderDate ? 'accent-text' : ''}" title="Notu ve Hatırlatıcıyı Düzenle"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 12.5A.5.5 0 0 1 5 12h3.793l1.147-1.146a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .5-.5m.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1z"/><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1z"/></svg></button>
                            <button data-action="deliver" class="p-2 text-green-400 hover:text-green-300 rounded-full transition" title="Teslim Et"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg></button>
                            <button data-action="delete-item" class="p-2 text-red-500 hover:text-red-400 rounded-full transition" title="Kaydı Sil">${icons.cancel_item}</button>
                        </div>
                        <div class="edit-count-actions hidden flex items-center gap-2">
                             <input type="number" value="${item.bagCount}" min="1" class="w-16 p-1 bg-secondary border border-dynamic text-primary rounded-md text-sm focus:ring-1 ring-accent transition">
                             <button data-action="save-count" class="p-2 text-green-400 hover:text-green-300 transition" title="Kaydet">${icons.save}</button>
                             <button data-action="cancel-edit-count" class="p-2 text-red-500 hover:text-red-400 transition" title="Vazgeç">${icons.cancel}</button>
                        </div>
                    </div>`;
                return div;
            }
            
            function renderArchive(items) {
                const searchQuery = toTrUpperCase(allElements.searchArchiveInput.value);
                let filteredItems = items.filter(item => toTrUpperCase(item.customerName).includes(searchQuery));
                
                filteredItems.sort((a,b) => {
                    const dateA = a.deliveredAt?.seconds || 0;
                    const dateB = b.deliveredAt?.seconds || 0;
                    return dateB - dateA;
                });
                
                allElements.emptyArchiveListMessage.style.display = filteredItems.length === 0 ? 'block' : 'none';

                const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
                if(archiveCurrentPage > totalPages && totalPages > 0) archiveCurrentPage = totalPages;

                const startIndex = (archiveCurrentPage - 1) * itemsPerPage;
                const paginatedItems = filteredItems.slice(startIndex, startIndex + itemsPerPage);

                allElements.archiveList.innerHTML = '';
                paginatedItems.forEach(item => allElements.archiveList.appendChild(createArchiveItemElement(item)));

                renderArchivePagination(totalPages);
            }
            
            function createArchiveItemElement(item) {
                const div = document.createElement('div');
                div.className = 'bg-primary/50 opacity-70 p-4 rounded-lg shadow-md flex items-center justify-between border border-dynamic';
                div.dataset.id = item.id;

                const deliveredByHtml = item.deliveredBy 
                    ? `<p class="item-subtext text-xs text-secondary/80 mt-1">Teslim Eden: ${item.deliveredBy}</p>` 
                    : '';

                div.innerHTML = `
                    <div class="item-details flex-1 flex items-center gap-4">
                        <div class="item-bag-count bg-slate-600/50 text-slate-400 font-bold w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full text-xl">${item.bagCount}</div>
                        <div class="flex-1">
                            <p class="item-customer-name font-semibold text-lg text-primary/80">${item.customerName}</p>
                            <p class="item-subtext text-sm text-secondary">Teslim Edildi: ${formatDate(item.deliveredAt)}</p>
                            ${deliveredByHtml}
                        </div>
                    </div>
                    <div class="item-actions flex items-center gap-2 ml-2">
                        <button data-action="restore" class="p-2 text-secondary hover:text-yellow-400 rounded-full transition" title="Geri Yükle"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg></button>
                        <button data-action="delete-permanent" class="p-2 text-secondary hover:text-red-500 rounded-full transition" title="Kalıcı Olarak Sil"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg></button>
                    </div>`;
                return div;
            }
            
            function renderNotes() {
                const itemsWithNotes = allItems.filter(item => (item.note && item.note.trim() !== '') || item.reminderDate).sort((a,b) => {
                    const dateA = a.lastModified?.seconds || 0;
                    const dateB = b.lastModified?.seconds || 0;
                    return dateB - dateA;
                });
                allElements.notesList.innerHTML = '';
                allElements.emptyNotesMessage.classList.toggle('hidden', itemsWithNotes.length > 0);
                itemsWithNotes.forEach(item => allElements.notesList.appendChild(createNoteElement(item)));
            }

            function createNoteElement(item) {
                const div = document.createElement('div');
                div.className = 'bg-primary p-4 rounded-lg shadow-md border border-dynamic';
                div.dataset.id = item.id;
                let reminderHtml = '';
                if (item.reminderDate) {
                    reminderHtml = `<p class="text-sm mt-2 text-cyan-300"><strong>Hatırlatıcı:</strong> ${item.reminderDate}</p>`;
                }
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                         <p class="font-semibold accent-text">${item.customerName}</p>
                         <button data-action="delete-note-from-tab" class="p-1 -mt-1 -mr-1 text-secondary hover:text-red-500 rounded-full transition" title="Notu ve Hatırlatıcıyı Sil">
                             <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z"/></svg>
                        </button>
                    </div>
                    <p class="text-primary mt-2 whitespace-pre-wrap">${item.note || '<i>Not içeriği boş.</i>'}</p>
                    ${reminderHtml}
                `;
                return div;
            }
            
            function renderReports() {
                renderPeriodicReport(); 
                renderOverdueReport();
            }
            
            function renderOverdueReport() {
                const overdueList = document.getElementById('overdue-report-list');
                const overdueMessage = document.getElementById('empty-overdue-report-message');
                const activeItems = allItems.filter(item => item.status !== 'delivered');

                if (activeItems.length === 0) {
                    overdueList.innerHTML = '';
                    overdueMessage.classList.remove('hidden');
                    return;
                }
                
                overdueMessage.classList.add('hidden');
                activeItems.sort((a, b) => {
                       const dateA = a.lastModified?.seconds || 0;
                       const dateB = b.lastModified?.seconds || 0;
                       return dateA - dateB;
                });
                const top10 = activeItems.slice(0, 10);

                overdueList.innerHTML = top10.map((item, index) => {
                    return `<div class="bg-tertiary p-3 rounded-md flex justify-between items-center">
                                 <span class="text-primary">${index + 1}. ${item.customerName}</span>
                                 <span class="text-sm text-secondary">${formatRelativeTime(item.lastModified)}</span>
                             </div>`;
                }).join('');
            }
            
            function renderPeriodicReport(range = null) {
                const contentDiv = document.getElementById('periodic-report-content');
                if(range === null) {
                    const activeBtn = document.querySelector('.report-range-btn.accent-bg');
                    if (activeBtn) range = activeBtn.dataset.range;
                    else {
                         contentDiv.innerHTML = 'Raporu görmek için bir zaman aralığı seçin.';
                         return; 
                    }
                }
                
                let added, delivered;
                
                if (range === 'all') {
                    added = allItems.length;
                    delivered = allItems.filter(i => i.status === 'delivered').length;
                } else {
                    const rangeNum = parseInt(range, 10);
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - rangeNum);

                    added = allItems.filter(i => (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : new Date(i.createdAt)) >= startDate).length;
                    delivered = allItems.filter(i => i.status === 'delivered' && (i.deliveredAt?.seconds ? new Date(i.deliveredAt.seconds * 1000) : new Date(i.deliveredAt)) >= startDate).length;
                }

                contentDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-3xl font-bold text-green-400">${added}</p>
                            <p class="text-sm text-secondary">Yeni Poşet Eklendi</p>
                        </div>
                        <div>
                            <p class="text-3xl font-bold text-blue-400">${delivered}</p>
                            <p class="text-sm text-secondary">Poşet Teslim Edildi</p>
                        </div>
                    </div>
                `;
            }

            // --- FIRESTORE İŞLEMLERİ ---
            async function handleAddItem(e) {
                e.preventDefault();
                const customerName = toTrUpperCase(allElements.customerNameInput.value.trim());
                const bagCount = parseInt(allElements.bagCountInput.value, 10);
                if (!customerName || isNaN(bagCount) || bagCount < 1) return;

                try {
                    const activeItems = allItems.filter(item => item.status === 'active');
                    const existingItem = activeItems.find(item => toTrUpperCase(item.customerName) === customerName);

                    if (existingItem) {
                        // Mevcut kaydı güncelle
                        const itemRef = doc(db, 'items', existingItem.id);
                        const datesToAdd = Array(bagCount).fill(null).map(() => new Date());

                        await updateDoc(itemRef, {
                            bagCount: existingItem.bagCount + bagCount,
                            lastModified: serverTimestamp(),
                            additionalDates: arrayUnion(...datesToAdd)
                        });
                    } else {
                        // Yeni kayıt oluştur
                        const customerExists = allCustomers.some(c => c.name.toLowerCase() === customerName.toLowerCase());
                        if (!customerExists) {
                            await addDoc(collection(db, 'customers'), { name: customerName });
                        }

                        await addDoc(collection(db, 'items'), {
                            customerName,
                            bagCount,
                            note: '',
                            status: 'active',
                            createdAt: serverTimestamp(),
                            lastModified: serverTimestamp(),
                            deliveredAt: null,
                            deliveredBy: null,
                            additionalDates: [],
                            reminderDate: null
                        });
                    }
                    
                    allElements.addItemForm.reset();
                    allElements.bagCountInput.value = 1;
                    allElements.customerNameInput.focus();

                } catch (error) {
                    console.error("Error in handleAddItem: ", error);
                    showSimpleMessageModal("Hata", "Kayıt eklenirken veya güncellenirken bir hata oluştu.");
                }
            }

            async function updateItem(id, data) {
                if (data.note !== undefined) {
                    data.note = toTrUpperCase(data.note);
                }
                const itemRef = doc(db, 'items', id);
                await updateDoc(itemRef, { ...data, lastModified: serverTimestamp() });
            }

            async function deleteItem(id) {
                await deleteDoc(doc(db, 'items', id));
            }
            
            async function deleteCustomer(id) {
                await deleteDoc(doc(db, 'customers', id));
            }
            
            async function updateCustomerNameAndItems(customerId, oldName, newName) {
                const upperNewName = toTrUpperCase(newName);
                allElements.loadingText.textContent = 'Müşteri adı ve ilgili poşetler güncelleniyor...';
                allElements.loadingOverlay.style.display = 'flex';
                allElements.loadingOverlay.style.opacity = '1';
                try {
                    const batch = writeBatch(db);

                    const customerRef = doc(db, 'customers', customerId);
                    batch.update(customerRef, { name: upperNewName });
                    
                    const itemsQuery = query(collection(db, 'items'), where("customerName", "==", oldName));
                    const itemsSnapshot = await getDocs(itemsQuery);
                    itemsSnapshot.forEach(itemDoc => {
                        batch.update(itemDoc.ref, { customerName: upperNewName });
                    });
                    
                    await batch.commit();
                } catch(error) {
                       console.error("Müşteri adı güncellenirken hata:", error);
                       showSimpleMessageModal("Hata", "Müşteri adı güncellenirken bir sorun oluştu.");
                } finally {
                    allElements.loadingOverlay.style.opacity = '0';
                    setTimeout(() => { allElements.loadingOverlay.style.display = 'none'; }, 300);
                }
            }

            async function importDataFromJSON(data) {
                if (!data.allItems || !data.allCustomers) {
                    showSimpleMessageModal('Hata', 'Geçersiz yedek dosyası formatı.');
                    return;
                }

                allElements.loadingText.textContent = 'Veriler siliniyor...';
                
                const itemsBatch = writeBatch(db);
                allItems.forEach(item => itemsBatch.delete(doc(db, 'items', item.id)));
                await itemsBatch.commit();
                
                const customersBatch = writeBatch(db);
                allCustomers.forEach(customer => customersBatch.delete(doc(db, 'customers', customer.id)));
                await customersBatch.commit();

                allElements.loadingText.textContent = 'Veriler içe aktarılıyor...';
                
                const newItemsBatch = writeBatch(db);
                data.allItems.forEach(item => {
                    const newItemRef = doc(collection(db, 'items'));
                    const cleanItem = { ...item };
                    delete cleanItem.id;
                    if (cleanItem.customerName) cleanItem.customerName = toTrUpperCase(cleanItem.customerName);
                    if (cleanItem.note) cleanItem.note = toTrUpperCase(cleanItem.note);
                    if (cleanItem.createdAt) cleanItem.createdAt = new Date(cleanItem.createdAt.seconds ? cleanItem.createdAt.seconds * 1000 : cleanItem.createdAt);
                    if (cleanItem.lastModified) cleanItem.lastModified = new Date(cleanItem.lastModified.seconds ? cleanItem.lastModified.seconds * 1000 : cleanItem.lastModified);
                    if (cleanItem.deliveredAt) cleanItem.deliveredAt = new Date(cleanItem.deliveredAt.seconds ? cleanItem.deliveredAt.seconds * 1000 : cleanItem.deliveredAt);
                    newItemsBatch.set(newItemRef, cleanItem);
                });
                await newItemsBatch.commit();

                const newCustomersBatch = writeBatch(db);
                data.allCustomers.forEach(customer => {
                    const newCustomerRef = doc(collection(db, 'customers'));
                    const cleanCustomer = { ...customer };
                    if (cleanCustomer.name) cleanCustomer.name = toTrUpperCase(cleanCustomer.name);
                    delete cleanCustomer.id;
                    newCustomersBatch.set(newCustomerRef, cleanCustomer);
                });
                await newCustomersBatch.commit();

                showSimpleMessageModal('Başarılı', 'Veriler başarıyla geri yüklendi.');
            }
            
            async function resetAllData() {
                 allElements.loadingText.textContent = 'Tüm veriler siliniyor...';
                 allElements.loadingOverlay.style.display = 'flex';
                 allElements.loadingOverlay.style.opacity = '1';

                const itemsBatch = writeBatch(db);
                allItems.forEach(item => itemsBatch.delete(doc(db, 'items', item.id)));
                await itemsBatch.commit();
                
                const customersBatch = writeBatch(db);
                allCustomers.forEach(customer => customersBatch.delete(doc(db, 'customers', customer.id)));
                await customersBatch.commit();
                
                allElements.loadingOverlay.style.opacity = '0';
                setTimeout(() => { allElements.loadingOverlay.style.display = 'none'; }, 300);
            }

            // --- UYGULAMA BAŞLATMA VE VERİ DİNLEME ---
            function startFirebaseConnection() {
                clearTimeout(connectionTimeout);
                connectionTimeout = setTimeout(() => {
                    showConnectionError('Bağlantı zaman aşımına uğradı. İnternetinizi kontrol edin.');
                }, 10000); 

                try {
                    if (!app) {
                        app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                    }
                    
                    onAuthStateChanged(auth, user => {
                        clearTimeout(connectionTimeout);
                        if (user) {
                            listenToData();
                        } else {
                            signInAnonymously(auth).catch(error => {
                                console.error("Anonymous sign-in failed: ", error);
                                showConnectionError('Veritabanı ile kimlik doğrulaması yapılamadı.');
                            });
                        }
                    });
                } catch(e) {
                    clearTimeout(connectionTimeout);
                    console.error("Firebase initialization error:", e);
                    showConnectionError('Uygulama başlatılamadı. Yapılandırmayı kontrol edin.');
                }
            }

            function initialize() {
                settings = getSettingsFromStorage();
                seenNotifications = JSON.parse(localStorage.getItem('seenNotifications')) || [];
                applySettings();
                updateSortButtons();
                switchTab('list', true);
                
                allElements.retryButton.addEventListener('click', () => {
                    allElements.loadingText.textContent = 'Veritabanına bağlanılıyor...';
                    allElements.loadingSpinner.style.display = 'block';
                    allElements.retryContainer.classList.add('hidden');
                    isAppInitialized = false; // Allow re-initialization
                    startFirebaseConnection();
                });
                
                document.body.addEventListener('input', e => {
                    if (e.target.matches('input[type="text"], input[type="search"], textarea')) {
                        const start = e.target.selectionStart;
                        const end = e.target.selectionEnd;
                        e.target.value = toTrUpperCase(e.target.value);
                        e.target.setSelectionRange(start, end);
                    }
                });

                startFirebaseConnection();
                setupEventListeners();
            }
            
            function setupEventListeners() {
                allElements.addItemForm.addEventListener('submit', handleAddItem);
                allElements.searchArchiveInput.addEventListener('input', () => {
                    archiveCurrentPage = 1;
                    renderArchive(allItems.filter(item => item.status === 'delivered'));
                });
                allElements.sortAlphaBtn.addEventListener('click', () => handleSort('alpha'));
                allElements.sortBagsBtn.addEventListener('click', () => handleSort('bags'));
                allElements.sortDateBtn.addEventListener('click', () => handleSort('date'));
                
                allElements.mainContent.addEventListener('click', handleMainContentClick);
                allElements.exportArchivePdfBtn?.addEventListener('click', exportArchiveToPDF);
                allElements.exportReportsPdfBtn?.addEventListener('click', exportReportsToPDF);
                allElements.notificationBell?.addEventListener('click', showNotificationsModal);
                
                document.querySelector('#panel-settings').addEventListener('click', handleSettingsPanelClick);
            
                allElements.importFileInput.addEventListener('change', handleFileImport);
                
                document.getElementById('font-size-slider')?.addEventListener('input', (e) => {
                    settings.fontSize = e.target.value;
                    document.getElementById('font-size-preview').textContent = `${settings.fontSize}px`;
                    document.body.style.fontSize = `${settings.fontSize}px`;
                   });
                document.getElementById('font-size-slider')?.addEventListener('change', (e) => {
                    settings.fontSize = e.target.value;
                     saveSettingsToStorage(settings);
                   });
                
                document.querySelectorAll('.report-range-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.report-range-btn').forEach(b => b.classList.remove('accent-bg'));
                        btn.classList.add('accent-bg');
                        renderPeriodicReport(btn.dataset.range);
                    });
                });

                document.querySelector('nav').addEventListener('click', (e) => {
                    if (e.target.id && e.target.id.startsWith('tab-')) {
                        switchTab(e.target.id.replace('tab-', ''));
                    }
                });
                
                allElements.customerNameInput.addEventListener("input", () => {
                    const searchTerm = toTrUpperCase(allElements.customerNameInput.value.trim());
                    const clearBtn = allElements.clearCustomerNameBtn;
                    
                    if (searchTerm.length > 0) {
                        clearBtn.classList.remove('hidden');
                    } else {
                        clearBtn.classList.add('hidden');
                    }

                    const activeItems = allItems.filter(item => item.status !== 'delivered');
                    renderItems(activeItems);

                    allElements.suggestionsBox.innerHTML = "";
                    if (searchTerm.length === 0) {
                        allElements.suggestionsBox.classList.add("hidden");
                        return;
                    }

                    const filteredCustomers = allCustomers
                        .filter(c => toTrUpperCase(c.name).includes(searchTerm))
                        .map(c => c.name);

                    if (filteredCustomers.length > 0) {
                        filteredCustomers.forEach(name => {
                            const div = document.createElement("div");
                            div.textContent = name;
                            div.className = "p-3 hover:bg-slate-600 cursor-pointer text-primary";
                            div.addEventListener("click", () => {
                                allElements.customerNameInput.value = name;
                                allElements.suggestionsBox.classList.add("hidden");
                                renderItems(activeItems); 
                                allElements.bagCountInput.focus();
                            });
                            allElements.suggestionsBox.appendChild(div);
                        });
                        allElements.suggestionsBox.classList.remove("hidden");
                    } else {
                        allElements.suggestionsBox.classList.add("hidden");
                    }
                });

                allElements.clearCustomerNameBtn.addEventListener('click', () => {
                    allElements.customerNameInput.value = '';
                    allElements.clearCustomerNameBtn.classList.add('hidden');
                    // Trigger input event to re-render the list
                    allElements.customerNameInput.dispatchEvent(new Event('input'));
                    allElements.customerNameInput.focus();
                });


                document.addEventListener("click", (e) => {
                    if (!e.target.closest('.relative')) {
                        allElements.suggestionsBox.classList.add("hidden");
                    }
                });
            }

            function listenToData() {
                if (itemsUnsubscribe) itemsUnsubscribe();
                if (customersUnsubscribe) customersUnsubscribe();

                const itemsQuery = query(collection(db, "items"));
                itemsUnsubscribe = onSnapshot(itemsQuery, (snapshot) => {
                    allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAll();
                    showApp(); 
                }, error => {
                    console.error("Error listening to items: ", error);
                    showConnectionError('Veri alınırken bir hata oluştu.');
                });

                const customersQuery = query(collection(db, "customers"));
                customersUnsubscribe = onSnapshot(customersQuery, (snapshot) => {
                    allCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const modalList = document.getElementById('modal-customers-list');
                    if (modalList && !allElements.modalContainer.classList.contains('hidden')) {
                        const customerInput = document.getElementById('modal-customer-input');
                        renderCustomerModalList(customerInput?.value || '');
                    }
                }, error => {
                    console.error("Error listening to customers: ", error)
                    showConnectionError('Müşteri verileri alınamadı.');
                });
            }
            
            // --- EVENT HANDLERS ---
            async function handleMainContentClick(e) {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const itemDiv = button.closest('div[data-id]');

                if (action === 'view-customer') {
                    const customerName = itemDiv?.dataset.customerName;
                    if (customerName) {
                        showCustomerDetailModal(customerName);
                    }
                    return;
                }

                if (!itemDiv) return;

                const id = itemDiv.dataset.id;
                const item = allItems.find(i => i.id === id);
                if (!item) return;

                const defaultActions = itemDiv.querySelector('.default-actions');
                const editCountActions = itemDiv.querySelector('.edit-count-actions');

                switch (action) {
                    case 'deliver': {
                        const result = await showDeliverConfirmationModal(item);
                        if (result.confirmed) {
                            updateItem(id, {
                                status: 'delivered',
                                deliveredAt: serverTimestamp(),
                                deliveredBy: result.value
                            });
                        }
                        break;
                    }
                    case 'restore':
                        if (await showConfirmationModal(`'${item.customerName}' adlı kaydı bekleyenler listesine geri yüklemek istiyor musunuz?`, "Geri Yükle")) {
                            updateItem(id, { status: 'active', deliveredAt: null, deliveredBy: null });
                        }
                        break;
                    case 'delete-permanent':
                        if (await showConfirmationModal(`'${item.customerName}' adlı kayıt kalıcı olarak silinecektir. Bu işlem geri alınamaz. Emin misiniz?`, "Kalıcı Olarak Sil", true)) {
                            deleteItem(id);
                        }
                        break;
                    case 'delete-item':
                        if (await showConfirmationModal(`'${item.customerName}' adlı kayıt kalıcı olarak silinecektir. Bu işlem geri alınamaz. Emin misiniz?`, "Kaydı Sil", true)) {
                            deleteItem(id);
                        }
                        break;
                    case 'edit-note': {
                        const result = await showNoteModal(item);
                        if (result.confirmed) {
                            updateItem(id, { note: result.note, reminderDate: result.reminderDate });
                        }
                        break;
                    }
                    case 'delete-note-from-tab':
                        if (await showConfirmationModal(`'${item.customerName}' adlı kaydın notunu ve hatırlatıcısını silmek istediğinizden emin misiniz?`, "Notu Sil", true)) {
                            updateItem(id, { note: '', reminderDate: null });
                        }
                        break;
                    case 'edit-count':
                        defaultActions.classList.add('hidden');
                        editCountActions.classList.remove('hidden');
                        const input = editCountActions.querySelector('input');
                        input.focus();
                        input.select();
                        break;
                    case 'cancel-edit-count':
                        editCountActions.classList.add('hidden');
                        defaultActions.classList.remove('hidden');
                        break;
                    case 'save-count': {
                        const saveInput = editCountActions.querySelector('input');
                        const newBagCount = parseInt(saveInput.value, 10);
                        if (isNaN(newBagCount) || newBagCount < 1) {
                            showSimpleMessageModal("Geçersiz Sayı", "Poşet sayısı en az 1 olmalıdır.");
                            return;
                        }

                        const oldBagCount = item.bagCount;
                        const updatePayload = {
                            bagCount: newBagCount
                        };

                        const countDifference = newBagCount - oldBagCount;

                        if (countDifference !== 0) {
                            const currentDates = [...(item.additionalDates || [])];
                            let newDates;
                            
                            if (countDifference > 0) { // Poşet sayısı ARTTI
                                // Eklenen her poşet için yeni bir tarih oluştur
                                const datesToAdd = Array(countDifference).fill(null).map(() => new Date());
                                newDates = [...currentDates, ...datesToAdd];
                            } else { // Poşet sayısı AZALDI
                                // Azalan miktar kadar tarihi sondan sil
                                const numberToRemove = Math.abs(countDifference);
                                newDates = currentDates.slice(0, -numberToRemove);
                            }
                            updatePayload.additionalDates = newDates;
                        }

                        await updateItem(id, updatePayload);
                        break;
                    }
                }
            }


            async function handleSettingsPanelClick(e) {
                 const themeBtn = e.target.closest('.theme-btn');
                 if(themeBtn) {
                      settings.theme = themeBtn.dataset.theme;
                      saveSettingsToStorage(settings);
                      applySettings();
                      return;
                 }
                 
                 const targetId = e.target.id;
                 switch(targetId) {
                     case 'manage-customers-btn':
                         showCustomerManagementModal();
                         break;
                     case 'export-json-btn':
                         exportDataToJSON();
                         break;
                     case 'import-json-btn':
                         allElements.importFileInput.click();
                         break;
                     case 'export-active-pdf-btn':
                         exportActiveItemsToPDF();
                         break;
                     case 'export-csv-btn':
                         exportToCSV();
                         break;
                     case 'reset-items-btn': {
                         const passwordCorrect = await showPasswordPrompt();
                         if (passwordCorrect) {
                              if(await showConfirmationModal("Tüm bekleyen ve teslim edilen poşet kayıtlarını kalıcı olarak silmek istediğinizden emin misiniz? Müşteri listesi etkilenmeyecektir. Bu işlem geri alınamaz.", "Evet, Sil", true)) {
                                 allElements.loadingText.textContent = 'Poşetler siliniyor...';
                                 allElements.loadingOverlay.style.display = 'flex';
                                 const batch = writeBatch(db);
                                 allItems.forEach(item => batch.delete(doc(db, 'items', item.id)));
                                 await batch.commit();
                                 allElements.loadingOverlay.style.display = 'none';
                              }
                         }
                         break;
                     }
                     case 'reset-all-btn': {
                         const passwordCorrect = await showPasswordPrompt();
                         if (passwordCorrect) {
                             if (await showConfirmationModal("Uygulamadaki TÜM poşet ve müşteri verilerini kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.", "EVET, TÜMÜNÜ SİL", true)) {
                                 resetAllData();
                             }
                         }
                         break;
                     }
                 }
            }
            
            async function handleFileImport(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (await showConfirmationModal("Mevcut tüm verileriniz bu yedeklemedeki verilerle değiştirilecektir. Bu işlem geri alınamaz. Emin misiniz?", "Onayla ve Yükle", true)) {
                            allElements.loadingOverlay.style.display = 'flex';
                            await importDataFromJSON(data);
                            allElements.loadingOverlay.style.display = 'none';
                        }
                    } catch (error) {
                        console.error("Import error:", error);
                        showSimpleMessageModal('Hata', 'Yedek dosyası okunurken hata oluştu.');
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            }
            
            // --- MODAL, SIRALAMA VE DİĞER YARDIMCI FONKSİYONLAR ---
            function switchTab(target, instant = false) {
                const tabs = document.querySelectorAll('nav button[id^="tab-"]');
                const panels = document.querySelectorAll('.panel[id^="panel-"]');
                
                tabs.forEach(tab => tab.classList.remove('tab-active'));
                document.getElementById(`tab-${target}`).classList.add('tab-active');

                panels.forEach(panel => {
                    const isTargetPanel = panel.id === `panel-${target}`;
                    if (instant) {
                        panel.style.transition = 'none';
                        panel.classList.toggle('hidden', !isTargetPanel);
                        requestAnimationFrame(() => panel.style.transition = '');
                    } else {
                        panel.classList.toggle('hidden', !isTargetPanel);
                    }
                });
            }

            function handleSort(type) {
                if (sortState.type === type) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.type = type;
                    // Tarih ve poşet sayısı için varsayılan olarak azalan (yeni/çok olan üstte) sıralama yap,
                    // alfabe için artan (A'dan Z'ye) yap.
                    sortState.direction = (type === 'alpha') ? 'asc' : 'desc';
                }
                updateSortButtons();
                renderItems(allItems.filter(item => item.status !== 'delivered'));
            }

            function updateSortButtons() {
                [allElements.sortAlphaBtn, allElements.sortBagsBtn, allElements.sortDateBtn].forEach(btn => btn.classList.remove('sort-active'));
                const activeBtn = document.getElementById(`sort-${sortState.type}`);
                if (activeBtn) activeBtn.classList.add('sort-active');

                allElements.sortAlphaBtn.innerHTML = icons[`alpha_${sortState.type === 'alpha' ? sortState.direction : 'asc'}`];
                allElements.sortBagsBtn.innerHTML = icons[`bags_${sortState.type === 'bags' ? sortState.direction : 'desc'}`];
                allElements.sortDateBtn.innerHTML = icons[`date_${sortState.type === 'date' ? sortState.direction : 'desc'}`];
            }
            
            function renderArchivePagination(totalPages) {
                allElements.archivePagination.innerHTML = '';
                if(totalPages <= 1) return;

                const createBtn = (text, onClick, disabled = false) => {
                    const btn = document.createElement('button');
                    btn.innerHTML = text;
                    btn.className = 'pagination-btn p-2 bg-tertiary rounded-lg hover:accent-bg transition disabled:opacity-50 disabled:cursor-not-allowed';
                    btn.disabled = disabled;
                    btn.onclick = onClick;
                    return btn;
                }

                allElements.archivePagination.appendChild(createBtn('&laquo;', () => { archiveCurrentPage--; renderArchive(allItems.filter(i => i.status === 'delivered')) }, archiveCurrentPage === 1));

                for(let i = 1; i <= totalPages; i++) {
                    const pageBtn = createBtn(i, () => { archiveCurrentPage = i; renderArchive(allItems.filter(i => i.status === 'delivered')) });
                    if (i === archiveCurrentPage) pageBtn.classList.add('active');
                    allElements.archivePagination.appendChild(pageBtn);
                }

                allElements.archivePagination.appendChild(createBtn('&raquo;', () => { archiveCurrentPage++; renderArchive(allItems.filter(i => i.status === 'delivered')) }, archiveCurrentPage === totalPages));
            }

            function showModalUI() {
                allElements.modalContainer.classList.remove('hidden');
                requestAnimationFrame(() => {
                    allElements.modalContainer.style.opacity = '1';
                    allElements.modalContentWrapper.classList.remove('scale-95', 'opacity-0');
                });
            }

            function hideModalUI() {
                allElements.modalContainer.style.opacity = '0';
                allElements.modalContentWrapper.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    allElements.modalContainer.classList.add('hidden');
                    allElements.modalContent.innerHTML = '';
                }, 300);
            }
            
            function showSimpleMessageModal(title, message) {
                return new Promise(resolve => {
                       const modalHtml =`
                            <h3 class="text-xl font-semibold mb-2 text-primary">${title}</h3>
                            <p class="text-secondary mb-4">${message}</p>
                            <div class="flex justify-end gap-3">
                                <button id="modal-confirm" class="accent-bg text-white px-4 py-2 rounded-lg accent-bg-hover transition">Tamam</button>
                            </div>`;
                        allElements.modalContent.innerHTML = modalHtml;
                        const confirmBtn = allElements.modalContent.querySelector('#modal-confirm');
                        const close = () => {
                            hideModalUI();
                            resolve(true);
                        }
                        confirmBtn.addEventListener('click', close, {once: true});
                        showModalUI();
                });
            }

            function showConfirmationModal(message, confirmText = "Onayla", isDestructive = false) {
                 return new Promise(resolve => {
                    const confirmClass = isDestructive ? 'bg-red-600 hover:bg-red-700' : 'accent-bg accent-bg-hover';
                    const modalHtml = `
                        <h3 class="text-xl font-semibold mb-2 ${isDestructive ? 'text-red-400' : 'text-primary'}">Onay</h3>
                        <p class="text-secondary mb-6">${message}</p>
                        <div class="flex justify-end gap-3">
                            <button id="modal-cancel" class="bg-tertiary px-4 py-2 rounded-lg hover:bg-slate-500 transition">İptal</button>
                            <button id="modal-confirm" class="${confirmClass} text-white px-4 py-2 rounded-lg transition">${confirmText}</button>
                        </div>`;
                    allElements.modalContent.innerHTML = modalHtml;
                    
                    const confirmBtn = allElements.modalContent.querySelector('#modal-confirm');
                    const cancelBtn = allElements.modalContent.querySelector('#modal-cancel');
                    
                    const close = (confirmed) => {
                        confirmBtn.removeEventListener('click', () => close(true));
                        cancelBtn.removeEventListener('click', () => close(false));
                        hideModalUI();
                        resolve(confirmed);
                    }
                    
                    confirmBtn.addEventListener('click', () => close(true), { once: true });
                    cancelBtn.addEventListener('click', () => close(false), { once: true });

                    showModalUI();
                });
            }

            async function showDeliverConfirmationModal(item) {
                 return new Promise(resolve => {
                    const deliveryPersonnel = [ 'Cengiz Tuna', 'Süleyman Özgür', 'Muhammed Ali Koç', 'Fatih köse', 'Abdullah Alalalı', 'Ömer Alioğlu', 'Murat Avaid', 'Mahir Avaid' ];
                    const optionsHtml = deliveryPersonnel.map(name => `<option value="${name}" ${name === 'Cengiz Tuna' ? 'selected' : ''}>${name}</option>`).join('');
                    const modalHtml =`
                        <h3 class="text-xl font-semibold mb-2 text-primary">Teslimatı Onayla</h3>
                        <p class="text-secondary mb-4">'${item.customerName}' adlı müşterinin poşetini teslim etmek istediğinizden emin misiniz?</p>
                        <div class="mb-6">
                            <label for="delivered-by-select" class="block text-sm font-medium text-secondary mb-1">Teslim Eden Kişi:</label>
                            <select id="delivered-by-select" class="w-full p-2 bg-tertiary border border-dynamic rounded-lg focus:ring-2 ring-accent transition">
                                ${optionsHtml}
                            </select>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button id="modal-cancel" class="bg-tertiary px-4 py-2 rounded-lg hover:bg-slate-500 transition">İptal</button>
                            <button id="modal-confirm" class="accent-bg text-white px-4 py-2 rounded-lg accent-bg-hover transition">Teslim Et</button>
                        </div>`;
                    allElements.modalContent.innerHTML = modalHtml;

                    const confirmBtn = allElements.modalContent.querySelector('#modal-confirm');
                    const cancelBtn = allElements.modalContent.querySelector('#modal-cancel');
                    const select = allElements.modalContent.querySelector('#delivered-by-select');

                    const close = (confirmed) => {
                         hideModalUI();
                         resolve({ confirmed, value: confirmed ? select.value : null });
                    };
                    confirmBtn.addEventListener('click', () => close(true), { once: true });
                    cancelBtn.addEventListener('click', () => close(false), { once: true });
                    showModalUI();
                });
            }
            
            async function showNoteModal(item) {
                return new Promise(resolve => {
                    const modalHtml = `
                        <h3 class="text-xl font-semibold mb-2 text-primary">Not ve Hatırlatıcı</h3>
                        <p class="text-secondary mb-4">'${item.customerName}' için notu ve hatırlatıcıyı düzenleyin.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="note-textarea" class="block text-sm font-medium text-secondary mb-1">Not:</label>
                                <textarea id="note-textarea" class="w-full p-2 bg-secondary border border-dynamic rounded-lg focus:ring-2 ring-accent transition h-24">${item.note || ''}</textarea>
                            </div>
                            <div>
                                <label for="reminder-date" class="block text-sm font-medium text-secondary mb-1">Hatırlatma Tarihi (Opsiyonel):</label>
                                <input type="date" id="reminder-date" value="${item.reminderDate || ''}" class="w-full p-2 bg-secondary border border-dynamic rounded-lg focus:ring-2 ring-accent transition">
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button id="modal-cancel" class="bg-tertiary px-4 py-2 rounded-lg hover:bg-slate-500 transition">İptal</button>
                            <button id="modal-confirm" class="accent-bg text-white px-4 py-2 rounded-lg accent-bg-hover transition">Kaydet</button>
                        </div>`;
                    allElements.modalContent.innerHTML = modalHtml;
                    
                    const confirmBtn = allElements.modalContent.querySelector('#modal-confirm');
                    const cancelBtn = allElements.modalContent.querySelector('#modal-cancel');
                    const noteTextarea = allElements.modalContent.querySelector('#note-textarea');
                    const reminderDateInput = allElements.modalContent.querySelector('#reminder-date');

                    const close = (confirmed) => {
                         hideModalUI();
                         resolve({ 
                             confirmed, 
                             note: noteTextarea.value, 
                             reminderDate: reminderDateInput.value || null 
                         });
                    };
                    confirmBtn.addEventListener('click', () => close(true), { once: true });
                    cancelBtn.addEventListener('click', () => close(false), { once: true });
                    showModalUI();
                });
            }

            async function showPasswordPrompt() {
                return new Promise(resolve => {
                    const modalHtml = `
                        <h3 class="text-xl font-semibold mb-2 text-yellow-400">Güvenlik Onayı</h3>
                        <p class="text-secondary mb-4">Bu tehlikeli bir işlemdir. Devam etmek için lütfen yönetici şifresini girin.</p>
                        <div>
                            <label for="password-input" class="block text-sm font-medium text-secondary mb-1">Şifre:</label>
                            <input id="password-input" type="password" class="w-full p-2 bg-secondary border border-dynamic rounded-lg focus:ring-2 ring-accent transition" autofocus>
                            <p id="password-error" class="text-red-400 text-sm mt-2 hidden">Hatalı şifre. Lütfen tekrar deneyin.</p>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button id="modal-cancel" class="bg-tertiary px-4 py-2 rounded-lg hover:bg-slate-500 transition">İptal</button>
                            <button id="modal-confirm" class="accent-bg text-white px-4 py-2 rounded-lg accent-bg-hover transition">Onayla</button>
                        </div>`;
                    
                    allElements.modalContent.innerHTML = modalHtml;
                    showModalUI();
                    
                    const confirmBtn = allElements.modalContent.querySelector('#modal-confirm');
                    const cancelBtn = allElements.modalContent.querySelector('#modal-cancel');
                    const passwordInput = allElements.modalContent.querySelector('#password-input');
                    const errorMsg = allElements.modalContent.querySelector('#password-error');
                    
                    let keydownListener;
                    
                    const removeListenersAndHide = () => {
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                        document.removeEventListener('keydown', keydownListener);
                        hideModalUI();
                    };

                    const handleConfirm = () => {
                        if (passwordInput.value === '00042') {
                            removeListenersAndHide();
                            resolve(true);
                        } else {
                            errorMsg.classList.remove('hidden');
                            passwordInput.value = '';
                            passwordInput.focus();
                        }
                    };

                    const handleCancel = () => {
                        removeListenersAndHide();
                        resolve(false);
                    };

                    keydownListener = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleConfirm();
                        } else if (e.key === 'Escape') {
                            handleCancel();
                        }
                    };

                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                    document.addEventListener('keydown', keydownListener);
                    passwordInput.focus();
                });
            }

            function getUnseenOverdueItems() {
                const OVERDUE_DAYS = 20;
                const now = new Date();
                return allItems.filter(item => {
                    if (item.status !== 'active') return false;
                    const itemDate = item.createdAt?.seconds ? new Date(item.createdAt.seconds * 1000) : new Date(item.createdAt);
                    const diffDays = Math.floor((now - itemDate) / (1000 * 60 * 60 * 24));
                    return diffDays >= OVERDUE_DAYS && !seenNotifications.includes(item.id);
                });
            }
            
            function getUnseenReminders() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                return allItems.filter(item => {
                    if (item.status !== 'active' || !item.reminderDate) return false;
                    
                    // reminderDate is 'YYYY-MM-DD'. Need to parse it correctly considering timezones.
                    const [year, month, day] = item.reminderDate.split('-').map(Number);
                    const reminderDate = new Date(year, month - 1, day);
                    
                    return reminderDate <= today && !seenNotifications.includes(item.id);
                });
            }

            function checkAndDisplayNotifications() {
                const unseenReminders = getUnseenReminders();
                const unseenOverdue = getUnseenOverdueItems();
                const totalUnseen = new Set([...unseenReminders.map(i => i.id), ...unseenOverdue.map(i => i.id)]).size;

                if (totalUnseen > 0) {
                    allElements.notificationBadge.textContent = totalUnseen;
                    allElements.notificationBadge.classList.remove('hidden');
                } else {
                    allElements.notificationBadge.classList.add('hidden');
                }
            }

            function showNotificationsModal() {
                const unseenReminders = getUnseenReminders();
                const unseenOverdue = getUnseenOverdueItems();

                let modalHtml = `<div class="flex justify-between items-center mb-4">
                                     <h3 class="text-xl font-semibold text-primary">Bildirimler</h3>
                                      <button id="modal-close" class="p-1 text-secondary hover:text-primary transition">${icons.cancel}</button>
                                 </div>
                                 <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">`;
                
                // Reminders Section
                if (unseenReminders.length > 0) {
                    modalHtml += `<div>
                                    <h4 class="text-lg font-semibold text-cyan-300 mb-2">Bugünün Hatırlatmaları</h4>
                                    <div class="space-y-2">`;
                    unseenReminders.forEach(item => {
                        modalHtml += `
                            <div class="bg-tertiary/50 p-3 rounded-md flex justify-between items-center">
                                <div>
                                    <p class="text-primary font-medium">${item.customerName}</p>
                                    <p class="text-sm text-cyan-200">${item.note || 'Hatırlatıcı'}</p>
                                </div>
                                <button data-notif-id="${item.id}" class="mark-as-read-btn text-sm bg-slate-600 px-3 py-1 rounded-md hover:bg-slate-500 transition">Okundu</button>
                            </div>
                        `;
                    });
                    modalHtml += `</div></div>`;
                }

                // Overdue Section
                if (unseenOverdue.length > 0) {
                     modalHtml += `<div>
                                    <h4 class="text-lg font-semibold text-yellow-400 mb-2">Geciken Poşetler (20+ gün)</h4>
                                    <div class="space-y-2">`;
                    unseenOverdue.forEach(item => {
                         modalHtml += `
                            <div class="bg-tertiary/50 p-3 rounded-md flex justify-between items-center">
                                <div>
                                    <p class="text-primary font-medium">${item.customerName}</p>
                                    <p class="text-sm text-yellow-300">${formatRelativeTime(item.createdAt)}</p>
                                </div>
                                <button data-notif-id="${item.id}" class="mark-as-read-btn text-sm bg-slate-600 px-3 py-1 rounded-md hover:bg-slate-500 transition">Okundu</button>
                            </div>
                        `;
                    });
                     modalHtml += `</div></div>`;
                }

                if (unseenReminders.length === 0 && unseenOverdue.length === 0) {
                    modalHtml += `<p class="text-center text-secondary py-4">Okunmamış bildirim bulunmuyor.</p>`;
                }
                
                modalHtml += `</div>`; // End of scrollable area
                
                if (unseenReminders.length > 0 || unseenOverdue.length > 0) {
                    modalHtml += `<div class="mt-4 pt-4 border-t border-dynamic">
                                      <button id="mark-all-as-read" class="w-full bg-tertiary p-2 rounded-lg hover:bg-slate-600 transition">Tümünü Okundu İşaretle</button>
                                  </div>`;
                }

                allElements.modalContent.innerHTML = modalHtml;
                showModalUI();
                
                allElements.modalContent.querySelector('#modal-close')?.addEventListener('click', hideModalUI, {once: true});
                
                allElements.modalContent.querySelector('#mark-all-as-read')?.addEventListener('click', () => {
                    const allUnseenIds = [...unseenReminders.map(i => i.id), ...unseenOverdue.map(i => i.id)];
                    seenNotifications.push(...allUnseenIds);
                    localStorage.setItem('seenNotifications', JSON.stringify([...new Set(seenNotifications)]));
                    checkAndDisplayNotifications();
                    hideModalUI();
                });

                allElements.modalContent.querySelectorAll('.mark-as-read-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.target.dataset.notifId;
                        if (!seenNotifications.includes(itemId)) {
                             seenNotifications.push(itemId);
                        }
                        localStorage.setItem('seenNotifications', JSON.stringify(seenNotifications));
                        checkAndDisplayNotifications();
                        showNotificationsModal(); // Refresh modal content
                    });
                });
            }
            
            function showCustomerDetailModal(customerName) {
                const customerItems = allItems.filter(item => item.customerName === customerName);
                const activeItem = customerItems.find(item => item.status === 'active');
                const deliveredItems = customerItems.filter(item => item.status === 'delivered').sort((a,b) => (b.deliveredAt?.seconds || 0) - (a.deliveredAt?.seconds || 0));

                let modalHtml = `<div class="flex justify-between items-start mb-4">
                                     <h3 class="text-2xl font-bold accent-text">${customerName}</h3>
                                     <div class="flex items-center gap-2">
                                         <button id="export-customer-pdf-btn" class="p-2 text-secondary hover:text-rose-400 transition" title="Bu Müşterinin Geçmişini PDF Aktar">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                                         </button>
                                         <button id="modal-close" class="p-1 text-secondary hover:text-primary transition">${icons.cancel}</button>
                                     </div>
                                 </div>
                                 <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2">`;
                
                if (activeItem) {
                    modalHtml += `<div>
                                      <h4 class="text-lg font-semibold text-primary mb-2 border-b border-dynamic pb-1">Bekleyen Poşetler</h4>
                                      <div class="bg-tertiary/50 p-3 rounded-md">
                                          <p><span class="font-semibold">${activeItem.bagCount}</span> adet poşet</p>
                                          <p class="text-sm text-secondary mt-1">İlk Eklenme: ${formatDate(activeItem.createdAt)}</p>
                                          ${(activeItem.additionalDates && activeItem.additionalDates.length > 0) 
                                            ? activeItem.additionalDates.map(d => `<p class="text-xs text-secondary/80 pl-2">+ Eklenme: ${formatDate(d)}</p>`).join('') 
                                            : ''
                                          }
                                      </div>
                                  </div>`;
                }

                if (deliveredItems.length > 0) {
                     modalHtml += `<div>
                                      <h4 class="text-lg font-semibold text-primary mb-2 border-b border-dynamic pb-1">Teslim Edilenler</h4>
                                      <div id="customer-delivered-list" class="space-y-2"></div>
                                      <div id="customer-delivered-pagination" class="flex justify-center items-center mt-4 space-x-2"></div>
                                  </div>`;
                }

                if (activeItem && (activeItem.note || activeItem.reminderDate)) {
                     modalHtml += `<div>
                                      <h4 class="text-lg font-semibold text-primary mb-2 border-b border-dynamic pb-1">Not ve Hatırlatıcı</h4>
                                      <div class="bg-tertiary/50 p-3 rounded-md">
                                         <p class="whitespace-pre-wrap">${activeItem.note || '<i>Not girilmemiş.</i>'}</p>
                                         ${activeItem.reminderDate ? `<p class="text-sm mt-2 text-cyan-300"><strong>Hatırlatıcı:</strong> ${activeItem.reminderDate}</p>`: ''}
                                      </div>
                                  </div>`;
                }
                
                if (!activeItem && deliveredItems.length === 0) {
                     modalHtml += `<p class="text-center text-secondary py-4">Bu müşteri için kayıt bulunamadı.</p>`;
                }

                modalHtml += `</div>`;
                allElements.modalContent.innerHTML = modalHtml;
                showModalUI();

                if (deliveredItems.length > 0) {
                    renderCustomerDeliveredHistory(deliveredItems, 1);
                }

                allElements.modalContent.querySelector('#modal-close')?.addEventListener('click', hideModalUI, { once: true });
                allElements.modalContent.querySelector('#export-customer-pdf-btn')?.addEventListener('click', () => exportCustomerHistoryToPDF(customerName));
            }
            
            function renderCustomerDeliveredHistory(deliveredItems, page) {
                const listContainer = document.getElementById('customer-delivered-list');
                const paginationContainer = document.getElementById('customer-delivered-pagination');
                if (!listContainer || !paginationContainer) return;

                customerDetailCurrentPage = page;
                listContainer.innerHTML = '';
                paginationContainer.innerHTML = '';

                const totalPages = Math.ceil(deliveredItems.length / customerDetailItemsPerPage);
                const startIndex = (page - 1) * customerDetailItemsPerPage;
                const paginatedItems = deliveredItems.slice(startIndex, startIndex + customerDetailItemsPerPage);

                paginatedItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-tertiary/50 p-3 rounded-md';
                    div.innerHTML = `
                        <p><span class="font-semibold">${item.bagCount}</span> adet poşet</p>
                        <p class="text-sm text-secondary mt-1">Teslim Tarihi: ${formatDate(item.deliveredAt)}</p>
                        <p class="text-xs text-secondary/80">Teslim Eden: ${item.deliveredBy || '-'}</p>
                    `;
                    listContainer.appendChild(div);
                });

                if (totalPages > 1) {
                     for(let i = 1; i <= totalPages; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.textContent = i;
                        pageBtn.className = 'pagination-btn p-2';
                        if (i === page) pageBtn.classList.add('active');
                        pageBtn.onclick = () => renderCustomerDeliveredHistory(deliveredItems, i);
                        paginationContainer.appendChild(pageBtn);
                    }
                }
            }


            function renderCustomerModalList(filter = '') {
                const listContainer = document.getElementById('modal-customers-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const ucFilter = toTrUpperCase(filter);
                const filtered = allCustomers
                    .filter(c => toTrUpperCase(c.name).includes(ucFilter))
                    .sort((a, b) => a.name.localeCompare(b.name, 'tr'));

                if(filtered.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-secondary py-4">Filtreyle eşleşen müşteri bulunamadı.</p>';
                    return;
                }

                filtered.forEach(customer => {
                    const div = document.createElement('div');
                    div.className = 'p-2 bg-tertiary/50 rounded-md';
                    div.dataset.customerId = customer.id;
                    div.dataset.customerName = customer.name; // Orijinal ismi sakla
                    div.innerHTML = `
                        <div class="customer-display flex justify-between items-center">
                            <span class="customer-name-text text-primary text-sm">${customer.name}</span>
                            <div class="flex items-center gap-2">
                                <button data-cust-action="edit" class="p-1 text-secondary hover:text-yellow-400 transition" title="Düzenle">${icons.edit}</button>
                                <button data-cust-action="delete" class="p-1 text-secondary hover:text-red-500 transition" title="Sil">${icons.delete}</button>
                            </div>
                        </div>
                        <div class="customer-edit hidden flex items-center gap-2">
                            <input type="text" value="${customer.name}" class="customer-name-input flex-grow p-1 bg-secondary border border-dynamic text-primary rounded-md text-sm focus:ring-1 ring-accent transition">
                             <div class="flex items-center gap-1">
                                <button data-cust-action="save-edit" class="p-1 text-green-400 hover:text-green-300 transition" title="Kaydet">${icons.save}</button>
                                <button data-cust-action="cancel-edit" class="p-1 text-red-500 hover:text-red-400 transition" title="İptal">${icons.cancel}</button>
                            </div>
                        </div>
                        <div class="customer-delete-confirm hidden flex justify-between items-center">
                            <span class="text-red-300 text-sm">Silinsin mi?</span>
                            <div class="flex items-center gap-2">
                                <button data-cust-action="confirm-delete" class="text-sm bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Evet</button>
                                <button data-cust-action="cancel-delete" class="text-sm bg-tertiary px-2 py-1 rounded-md hover:bg-slate-500">Hayır</button>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
            
            async function showCustomerManagementModal() {
                 showModalUI();
                 allElements.modalContent.innerHTML =`
                    <div class="flex flex-col h-[70vh]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-primary">Müşteri Yönetimi</h3>
                            <button id="modal-close" class="p-1 text-secondary hover:text-primary transition">${icons.cancel}</button>
                        </div>
                        <div id="modal-customer-error" class="hidden text-center p-2 mb-2 bg-red-500/20 text-red-300 rounded-md text-sm"></div>
                        <form id="modal-customer-form" class="flex gap-2 mb-4">
                            <input type="text" id="modal-customer-input" placeholder="Müşteri Ara veya Yeni Müşteri Ekle..." class="flex-grow p-2 bg-secondary border border-dynamic text-primary rounded-lg focus:ring-2 ring-accent transition" required>
                            <button type="submit" class="accent-bg text-white font-semibold px-4 rounded-lg accent-bg-hover transition">Ekle</button>
                        </form>
                        <div id="modal-customers-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                    </div>
                `;
                
                const listContainer = document.getElementById('modal-customers-list');
                const customerForm = document.getElementById('modal-customer-form');
                const customerInput = document.getElementById('modal-customer-input');
                const errorDiv = document.getElementById('modal-customer-error');
                const closeBtn = document.getElementById('modal-close');
                
                closeBtn.addEventListener('click', hideModalUI, {once: true});

                function showModalError(message) {
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('hidden');
                    setTimeout(() => errorDiv.classList.add('hidden'), 3000);
                }

                customerInput.addEventListener('input', () => renderCustomerModalList(customerInput.value));
                
                listContainer.addEventListener('click', async e => {
                    const button = e.target.closest('button[data-cust-action]');
                    if (!button) return;

                    const action = button.dataset.custAction;
                    const customerDiv = button.closest('div[data-customer-id]');
                    const customerId = customerDiv.dataset.customerId;

                    const displayView = customerDiv.querySelector('.customer-display');
                    const editView = customerDiv.querySelector('.customer-edit');
                    const deleteConfirmView = customerDiv.querySelector('.customer-delete-confirm');

                    switch (action) {
                        case 'delete':
                            displayView.classList.add('hidden');
                            deleteConfirmView.classList.remove('hidden');
                            break;
                        case 'cancel-delete':
                            deleteConfirmView.classList.add('hidden');
                            displayView.classList.remove('hidden');
                            break;
                        case 'confirm-delete':
                             if (await showConfirmationModal("Bu müşteriyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.", "Evet, Sil", true)) {
                                await deleteCustomer(customerId);
                             }
                            break;
                        case 'edit':
                            displayView.classList.add('hidden');
                            editView.classList.remove('hidden');
                            editView.querySelector('input').focus();
                            break;
                        case 'cancel-edit':
                            editView.classList.add('hidden');
                            displayView.classList.remove('hidden');
                            break;
                        case 'save-edit':
                            const input = editView.querySelector('.customer-name-input');
                            const newName = input.value.trim();
                            const oldName = customerDiv.dataset.customerName;

                            if (!newName) {
                                showModalError("Müşteri adı boş olamaz.");
                                return;
                            }
                            if (toTrUpperCase(newName) === toTrUpperCase(oldName)) {
                                editView.classList.add('hidden');
                                displayView.classList.remove('hidden');
                                return;
                            }
                            const isDuplicate = allCustomers.some(c => toTrUpperCase(c.name) === toTrUpperCase(newName) && c.id !== customerId);
                            if (isDuplicate) {
                                showModalError("Bu isimde başka bir müşteri zaten var.");
                                return;
                            }
                            
                            if (await showConfirmationModal(`'${oldName}' ismini '${newName}' olarak değiştirmek istediğinizden emin misiniz? Bu işlem müşterinin tüm geçmiş kayıtlarını da güncelleyecektir.`, "Evet, Değiştir")) {
                               await updateCustomerNameAndItems(customerId, oldName, newName);
                            }
                            break;
                    }
                });
                
                customerForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const name = toTrUpperCase(customerInput.value.trim());
                    if (name && !allCustomers.some(c => toTrUpperCase(c.name) === name)) {
                       await addDoc(collection(db, 'customers'), { name });
                       customerInput.value = '';
                       customerInput.dispatchEvent(new Event('input')); // Filtreyi temizle
                    } else if (name) {
                       showModalError('Bu müşteri zaten mevcut.');
                    }
                });
                
                renderCustomerModalList();
            }
            
            function exportDataToJSON() {
                const data = { allItems, allCustomers, settings };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `poset-takip-yedek-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function exportToCSV() {
                const activeItems = allItems.filter(item => item.status !== 'delivered');
                if (activeItems.length === 0) { showSimpleMessageModal("Bilgi", "Dışa aktarılacak veri yok."); return; }
                
                const headers = "Musteri Adi,Poset Sayisi,Not,Son Degisiklik Tarihi";
                const rows = activeItems.map(item =>
                    `"${item.customerName.replace(/"/g, '""')}",${item.bagCount},"${(item.note || '').replace(/"/g, '""')}",${formatDate(item.lastModified)}`
                );

                const csvContent = "\uFEFF" + [headers, ...rows].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "poset_listesi.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function exportActiveItemsToPDF() {
                const activeItems = allItems.filter(item => item.status !== 'delivered');
                if (activeItems.length === 0) { showSimpleMessageModal("Bilgi", "Dışa aktarılacak bekleyen poşet yok."); return; }

                const pdf = new jsPDF();
                pdf.text("Bekleyen Poşet Listesi", 14, 16);
                
                const tableColumn = ["#", "Müşteri Adı", "Poşet Sayısı", "Eklenme Tarihi"];
                const tableRows = [];

                activeItems.forEach((item, index) => {
                    tableRows.push([
                        index + 1,
                        item.customerName,
                        item.bagCount,
                        formatDate(item.createdAt).split(' ')[0]
                    ]);
                });

                pdf.autoTable({ head: [tableColumn], body: tableRows, startY: 20 });
                pdf.save(`bekleyen-poset-listesi-${new Date().toISOString().slice(0,10)}.pdf`);
            }
            
            function exportArchiveToPDF() {
                const searchQuery = toTrUpperCase(allElements.searchArchiveInput.value);
                const archivedItems = allItems
                    .filter(item => item.status === 'delivered' && toTrUpperCase(item.customerName).includes(searchQuery))
                    .sort((a,b) => (b.deliveredAt?.seconds || 0) - (a.deliveredAt?.seconds || 0));

                if (archivedItems.length === 0) {
                    showSimpleMessageModal("Bilgi", "Arşivde dışa aktarılacak veri yok.");
                    return;
                }

                const pdf = new jsPDF();
                pdf.text("Teslim Edilenler Arşivi", 14, 16);
                
                const tableColumn = ["#", "Müşteri Adı", "Poşet", "Teslim Eden", "Teslim Tarihi"];
                const tableRows = [];

                archivedItems.forEach((item, index) => {
                    tableRows.push([
                        index + 1,
                        item.customerName,
                        item.bagCount,
                        item.deliveredBy || '-',
                        formatDate(item.deliveredAt).split(' ')[0]
                    ]);
                });

                pdf.autoTable({ head: [tableColumn], body: tableRows, startY: 20 });
                pdf.save(`teslim-edilenler-${new Date().toISOString().slice(0,10)}.pdf`);
            }
            
            function exportReportsToPDF() {
                const deliveredItems = allItems
                    .filter(item => item.status === 'delivered' && item.createdAt && item.deliveredAt)
                    .sort((a,b) => (b.deliveredAt?.seconds || 0) - (a.deliveredAt?.seconds || 0));

                if (deliveredItems.length === 0) {
                    showSimpleMessageModal("Bilgi", "Rapor oluşturulacak teslim edilmiş poşet bulunmuyor.");
                    return;
                }

                const pdf = new jsPDF();
                pdf.text("Teslim Edilen Poşet Raporu", 14, 16);
                
                const tableColumn = ["Müşteri Adı", "Alınma Tarihi", "Teslim Tarihi", "Bekleme Süresi (Gün)"];
                const tableRows = [];

                deliveredItems.forEach(item => {
                    tableRows.push([
                        item.customerName,
                        formatDate(item.createdAt).split(' ')[0],
                        formatDate(item.deliveredAt).split(' ')[0],
                        getDayDifference(item.createdAt, item.deliveredAt)
                    ]);
                });

                pdf.autoTable({ head: [tableColumn], body: tableRows, startY: 20 });
                pdf.save(`teslim-raporu-${new Date().toISOString().slice(0,10)}.pdf`);
            }
            function exportCustomerHistoryToPDF(customerName) {
                const customerItems = allItems.filter(item => item.customerName === customerName);
                if (customerItems.length === 0) {
                    showSimpleMessageModal("Bilgi", "Bu müşteri için dışa aktarılacak veri yok.");
                    return;
                }

                const pdf = new jsPDF();
                pdf.text(`${customerName} Müşteri Geçmişi`, 14, 16);

                const activeItem = customerItems.find(item => item.status === 'active');
                let lastY = 22;

                if (activeItem) {
                    pdf.autoTable({
                        startY: lastY,
                        head: [['Bekleyen Poşetler']],
                        body: [
                            [`Poşet Sayısı: ${activeItem.bagCount}`],
                            [`İlk Eklenme: ${formatDate(activeItem.createdAt)}`],
                        ],
                         theme: 'striped',
                         headStyles: { fillColor: [96, 70, 200] },
                    });
                     lastY = pdf.autoTable.previous.finalY;
                     if (activeItem.additionalDates && activeItem.additionalDates.length > 0) {
                         const additionalRows = activeItem.additionalDates.map(d => [`+ Eklenme: ${formatDate(d)}`]);
                         pdf.autoTable({
                             startY: lastY,
                             body: additionalRows,
                             theme: 'plain',
                             styles: { fontSize: 9, cellPadding: {top: 0.5, left: 2}},
                         });
                         lastY = pdf.autoTable.previous.finalY;
                    }
                }
                
                const deliveredItems = customerItems.filter(item => item.status === 'delivered').sort((a,b) => (b.deliveredAt?.seconds || 0) - (a.deliveredAt?.seconds || 0));

                if (deliveredItems.length > 0) {
                     pdf.autoTable({
                         startY: lastY + 10,
                         head: [['Teslim Edilenler Geçmişi']],
                         theme: 'striped',
                         headStyles: { fillColor: [45, 55, 72] },
                     });
                     const deliveredRows = deliveredItems.map(item => [
                         `Poşet: ${item.bagCount} | Teslim: ${formatDate(item.deliveredAt)} | Teslim Eden: ${item.deliveredBy || '-'}`
                    ]);
                     pdf.autoTable({
                         startY: pdf.autoTable.previous.finalY,
                         body: deliveredRows,
                         theme: 'plain',
                         styles: { fontSize: 9, cellPadding: 1 },
                     });
                }
                
                pdf.save(`${customerName}-gecmisi-${new Date().toISOString().slice(0,10)}.pdf`);
            }

            // --- UYGULAMAYI BAŞLAT ---
            initialize();
        });
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
